---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import YearGroup from "@components/YearGroup.astro";
import ListItem from "@components/ListItem.astro";
import Badge from "@components/kit/Badge.astro";
import { Icon } from "astro-icon/components";
import { getEffectivePubDate } from "@lib/blog";

export const prerender = true;

const allPosts = await getCollection("blog");

// Separate posts by language
const enPosts = allPosts
  .filter((post) => post.data.lang === "en")
  .sort((a, b) => getEffectivePubDate(b, allPosts).getTime() - getEffectivePubDate(a, allPosts).getTime());

const ruPosts = allPosts
  .filter((post) => post.data.lang === "ru")
  .sort((a, b) => getEffectivePubDate(b, allPosts).getTime() - getEffectivePubDate(a, allPosts).getTime());

// Create a map of original post ID -> translation for quick lookup
const translationMap = new Map<string, string>();
ruPosts.forEach((post) => {
  if (post.data.translationOf) {
    translationMap.set(post.data.translationOf, post.id);
  }
});

// Group posts by year (for each language)
// Posts are already sorted by pubDate desc, so we preserve that order within each year
function groupByYear(posts: typeof allPosts) {
  const byYear = posts.reduce<Record<number, typeof posts>>((acc, post) => {
    const year = getEffectivePubDate(post, allPosts).getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  }, {});
  // Sort posts within each year by pubDate descending, then by title for stable ordering
  for (const year of Object.keys(byYear)) {
    byYear[Number(year)].sort((a, b) => {
      const dateDiff = getEffectivePubDate(b, allPosts).getTime() - getEffectivePubDate(a, allPosts).getTime();
      if (dateDiff !== 0) return dateDiff;
      return a.data.title.localeCompare(b.data.title);
    });
  }
  const years = Object.keys(byYear)
    .map(Number)
    .sort((a, b) => b - a);
  return { byYear, years };
}

const enGrouped = groupByYear(enPosts);
const ruGrouped = groupByYear(ruPosts);

// Helper to get URL from post ID
// en/post-name -> /blog/post-name
// ru/post-name -> /blog/ru/post-name
function getPostUrl(id: string, lang: "en" | "ru"): string {
  const name = id.replace(/^(en|ru)\//, "");
  return lang === "ru" ? `/blog/ru/${name}` : `/blog/${name}`;
}

---

<PageLayout title="Blog â€” Zach">
  <main class="blog-page">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="container">
      <PageHeader
        variant="minimal"
        pageTitle={{ en: "Blog", ru: "Blog" }}
        subtitle={{
          en: "Thoughts, ideas, and occasional musings",
          ru: "Thoughts, ideas, and occasional musings",
        }}
        forceLang="en"
      />

      <!-- Posts -->
      <div class="posts-list">
        {
          enGrouped.years.map((year) => (
            <YearGroup year={year}>
              {enGrouped.byYear[year].map((post) => {
                const pubDate = getEffectivePubDate(post, allPosts);
                return (
                  <ListItem href={getPostUrl(post.id, "en")} interactive>
                    <time slot="date" datetime={pubDate.toISOString()}>
                      {pubDate.toLocaleDateString("en-US", {
                        day: "numeric",
                        month: "short",
                      })}
                    </time>
                    <span slot="title">{post.data.title}</span>
                    <div class="post-meta">
                      {post.data.tags?.map((tag: string) => (
                        <Badge size="sm">{tag}</Badge>
                      ))}
                      {translationMap.has(post.id) && (
                        <span class="translation-badge" title="Available in Russian">
                          <Icon name="globe" width={12} height={12} />
                          RU
                        </span>
                      )}
                    </div>
                  </ListItem>
                );
              })}
            </YearGroup>
          ))
        }
        {
          enPosts.length === 0 && (
            <div class="empty-state">
              <p>No posts yet. Check back soon!</p>
            </div>
          )
        }
      </div>
    </div>
  </main>
</PageLayout>

<style>
  .blog-page {
    --accent-start: rgb(237, 98, 146);
    --accent-end: rgb(237, 87, 96);

    min-height: 100vh;
    position: relative;
    overflow: hidden;
  }

  /* Ambient background blobs */
  .blob {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    z-index: 11;
  }

  .blob-1 {
    width: 500px;
    height: 500px;
    background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
    top: -200px;
    right: -150px;
    opacity: 0.15;
    animation: float1 12s ease-in-out infinite;
  }

  .blob-2 {
    width: 400px;
    height: 400px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    bottom: -150px;
    left: -100px;
    opacity: 0.1;
    animation: float2 15s ease-in-out infinite;
  }

  @keyframes float1 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    50% {
      transform: translate(-40px, 40px) scale(1.1);
    }
  }

  @keyframes float2 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    50% {
      transform: translate(30px, -30px) scale(1.05);
    }
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 720px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;

    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .posts-list {
    display: flex;
    flex-direction: column;
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.4rem;
  }

  .translation-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    background: light-dark(rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.15));
    border: 1px solid light-dark(rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.25));
    color: light-dark(#6366f1, #a78bfa);
    cursor: help;
    transition: all 0.2s ease;
  }

  .translation-badge:hover {
    background: light-dark(rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.22));
    border-color: light-dark(rgba(99, 102, 241, 0.35), rgba(139, 92, 246, 0.4));
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: light-dark(#666, #888);
  }

  .empty-state p {
    font-size: 1.1rem;
    margin: 0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .blob-1,
    .blob-2 {
      animation: none;
    }

    .translation-badge {
      transition: none;
    }
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .blob-1 {
      width: 300px;
      height: 300px;
      top: -100px;
      right: -100px;
    }

    .blob-2 {
      width: 250px;
      height: 250px;
      bottom: -100px;
      left: -80px;
    }

    .container {
      padding: 1.5rem 1rem 3rem;
    }
  }
</style>
