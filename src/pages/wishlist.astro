---
import PageLayout from "@layouts/PageLayout.astro";
import { Image } from "astro:assets";
import { db, WishlistItem, Reservation, ExchangeRate } from "astro:db";

// Opt out of prerendering - this page needs SSR for dynamic reservations
export const prerender = false;

type Currency = "USD" | "EUR" | "GBP" | "AUD";

type ParsedPrice = {
  amount: number; // In cents
  currency: Currency;
};

// Parse price string like "$64", "£25", "€300", "AU$140"
function parsePrice(price: string): ParsedPrice | null {
  const trimmed = price.trim();

  if (trimmed.startsWith("AU$")) {
    const amount = parseInt(trimmed.slice(3).replace(/,/g, ""), 10);
    return isNaN(amount) ? null : { amount: amount * 100, currency: "AUD" };
  }
  if (trimmed.startsWith("$")) {
    const amount = parseInt(trimmed.slice(1).replace(/,/g, ""), 10);
    return isNaN(amount) ? null : { amount: amount * 100, currency: "USD" };
  }
  if (trimmed.startsWith("£")) {
    const amount = parseInt(trimmed.slice(1).replace(/,/g, ""), 10);
    return isNaN(amount) ? null : { amount: amount * 100, currency: "GBP" };
  }
  if (trimmed.startsWith("€")) {
    const amount = parseInt(trimmed.slice(1).replace(/,/g, ""), 10);
    return isNaN(amount) ? null : { amount: amount * 100, currency: "EUR" };
  }

  return null;
}

type WishlistItemWithReservation = {
  id: number;
  title: string;
  titleRu: string | null;
  price: string;
  priceUsd: number | null; // Computed from price field
  priceRub: number | null; // Computed from priceUsd * exchange rate
  imageUrl: string;
  description: string | null;
  descriptionRu: string | null;
  url: string | null;
  category: string;
  priority: string | null;
  received: boolean;
  isReserved: boolean;
  reservedBy: string | null;
};

const categories = [
  { id: "all", label: "All", labelRu: "Все" },
  { id: "clothing", label: "Clothing", labelRu: "Одежда" },
  { id: "home", label: "Home", labelRu: "Дом" },
  { id: "vinyl", label: "Vinyl", labelRu: "Винил" },
  { id: "blu-ray", label: "Blu-ray", labelRu: "Blu-ray" },
  { id: "merch", label: "Merch", labelRu: "Мерч" },
  { id: "other", label: "Other", labelRu: "Другое" },
];

// Fetch wishlist items from database
const wishlistItemsRaw = await db.select().from(WishlistItem);

// Fetch all reservations
const reservations = await db.select().from(Reservation);

// Fetch all exchange rates
const exchangeRatesRaw = await db.select().from(ExchangeRate);

// Build exchange rate lookup: currency -> rate to RUB
const toRubRates: Record<Currency, number> = {
  USD: 100,
  EUR: 110,
  GBP: 130,
  AUD: 65,
};

// Override defaults with DB values
for (const rate of exchangeRatesRaw) {
  if (rate.toCurrency === "RUB" && rate.fromCurrency in toRubRates) {
    toRubRates[rate.fromCurrency as Currency] = rate.rate;
  }
}

// Compute priceUsd from original price
function computePriceUsd(price: string): number | null {
  const parsed = parsePrice(price);
  if (!parsed) return null;

  if (parsed.currency === "USD") {
    return parsed.amount;
  }

  // Convert to USD: amount_in_currency * (rate_to_rub / usd_to_rub_rate)
  const rateToRub = toRubRates[parsed.currency];
  const usdToRub = toRubRates.USD;
  return Math.round((parsed.amount * rateToRub) / usdToRub);
}

// Combine items with their reservation status and computed prices
const wishlistItemsWithReservations: WishlistItemWithReservation[] =
  wishlistItemsRaw.map((item) => {
    const reservation = reservations.find((r) => r.itemId === item.id);
    const priceUsd = computePriceUsd(item.price);
    const priceRub = priceUsd ? priceUsd * toRubRates.USD : null;

    return {
      ...item,
      priceUsd,
      priceRub,
      isReserved: !!reservation,
      reservedBy: reservation?.reservedBy ?? null,
    };
  });

// Sort items: by priority (high → medium → low → none), then received last
const priorityOrder: Record<string, number> = {
  high: 0,
  medium: 1,
  low: 2,
};

const wishlistItems = wishlistItemsWithReservations.sort((a, b) => {
  // Received items always go to the end
  if (a.received && !b.received) return 1;
  if (!a.received && b.received) return -1;

  // Sort by priority (high first, no priority last)
  const aPriority = a.priority ? (priorityOrder[a.priority] ?? 3) : 3;
  const bPriority = b.priority ? (priorityOrder[b.priority] ?? 3) : 3;
  return aPriority - bPriority;
});
---

<PageLayout title="Wishlist - Zach">
  <script is:inline>
    (() => {
      const LANG_KEY = "wishlist-lang";
      let lang = localStorage.getItem(LANG_KEY);

      // If no saved language, detect from browser
      if (!lang) {
        const browserLangs = navigator.languages || [navigator.language];
        const isRussian = browserLangs.some((l) =>
          l.toLowerCase().startsWith("ru"),
        );
        lang = isRussian ? "ru" : "en";
        localStorage.setItem(LANG_KEY, lang);
      }

      if (lang === "ru") {
        document.documentElement.classList.add("lang-ru");
      }

      // Generate visitorId if not exists
      if (!localStorage.getItem("wishlist-visitor-id")) {
        const id =
          crypto.randomUUID?.() ??
          Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem("wishlist-visitor-id", id);
      }
    })();
  </script>
  <style is:inline>
    .container {
      opacity: 0;
    }
    html.lang-ready .container {
      opacity: 1;
    }
  </style>
  <main>
    <div class="container">
      <header class="header">
        <h1 data-en="My Wishlist" data-ru="Мой вишлист">My Wishlist</h1>
        <p
          class="subtitle"
          data-en="Things I'd love to have"
          data-ru="Вещи, которые я хотел бы получить"
        >
          Things I'd love to have
        </p>
      </header>

      <div class="filters">
        <div class="filter-categories">
          {
            categories.map((cat) => (
              <button
                class={`filter-btn ${cat.id === "all" ? "active" : ""}`}
                data-category={cat.id}
                data-en={cat.label}
                data-ru={cat.labelRu}
              >
                {cat.label}
              </button>
            ))
          }
        </div>
        <div class="filter-lang">
          <div>
            <svg
              class="lang-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M2 12h20"></path>
              <path
                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
              ></path>
            </svg>
          </div>
          <button class="lang-btn" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="ru">RU</button>
        </div>
      </div>

      <div class="wishlist-grid" id="wishlist-grid">
        {
          wishlistItems.map((item) => (
            <article
              class={`wishlist-item ${item.received ? "item-received" : ""}`}
              data-item-id={item.id}
              data-category={item.category}
            >
              <div class="item-image">
                <div class="skeleton" />
                <Image
                  src={item.imageUrl}
                  alt={item.title}
                  width={400}
                  height={300}
                  loading="lazy"
                  decoding="async"
                  onload="this.parentElement.classList.add('loaded')"
                />
                {item.received && (
                  <div
                    class="received-badge"
                    data-en="Received"
                    data-ru="Получено"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M13.5 4L6 11.5L2.5 8"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    <span>Received</span>
                  </div>
                )}
                <div
                  class="own-reservation-badge"
                  data-en="Reserved by you"
                  data-ru="Вы зарезервировали"
                  hidden
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 16 16"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M13.5 4L6 11.5L2.5 8"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span>Reserved by you</span>
                </div>
              </div>
              <div class="item-content">
                <h3
                  class="item-title"
                  data-en={item.title}
                  data-ru={item.titleRu || item.title}
                >
                  {item.title}
                </h3>
                {item.url && (
                  <a
                    href={item.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="item-url"
                  >
                    {item.url
                      .replace(/^https?:\/\/(www\.)?/, "")
                      .replace(/\/$/, "")}
                  </a>
                )}
                {(item.description || item.descriptionRu) && (
                  <p
                    class="item-description"
                    data-en={item.description || ""}
                    data-ru={item.descriptionRu || item.description || ""}
                  >
                    {item.description}
                  </p>
                )}
                <div class="item-footer">
                  <span
                    class="item-price"
                    data-price-original={item.price}
                    data-price-usd={
                      item.priceUsd
                        ? `$${(item.priceUsd / 100).toFixed(0)}`
                        : null
                    }
                    data-price-rub={
                      item.priceRub
                        ? `₽${(item.priceRub / 100).toFixed(0)}`
                        : null
                    }
                    data-original-is-usd={
                      item.price.startsWith("$") ? "true" : null
                    }
                  >
                    {item.price}
                  </span>

                  <button
                    class={`reserve-btn${item.received ? " received" : ""}`}
                    data-item-id={item.id}
                    data-item-title={item.title}
                    data-reserved-by={item.reservedBy}
                    data-en-reserve="Reserve"
                    data-ru-reserve="Зарезервировать"
                    data-en-reserved="Reserved"
                    data-ru-reserved="Зарезервировано"
                    data-en-cancel="Cancel"
                    data-ru-cancel="Отменить"
                    data-en-received="Received"
                    data-ru-received="Получено"
                    disabled={item.received}
                  >
                    {item.received
                      ? "Received"
                      : item.isReserved
                        ? "Reserved"
                        : "Reserve"}
                  </button>
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </div>
  </main>

  <style>
    :root {
      --accent-start: rgb(237, 98, 146);
      --accent-end: rgb(237, 87, 96);
      --glass-bg-light: rgba(255, 255, 255, 0.7);
      --glass-bg-dark: rgba(40, 40, 45, 0.7);
      --glass-border-light: rgba(255, 255, 255, 0.5);
      --glass-border-dark: rgba(255, 255, 255, 0.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 1.5rem 5rem;
      position: relative;
    }

    /* Ambient background blobs */
    .container::before,
    .container::after {
      content: "";
      position: fixed;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.5;
      z-index: -1;
      pointer-events: none;
    }

    .container::before {
      width: 600px;
      height: 600px;
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      top: -200px;
      right: -200px;
      opacity: light-dark(0.15, 0.2);
    }

    .container::after {
      width: 500px;
      height: 500px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      bottom: 0;
      left: -150px;
      opacity: light-dark(0.1, 0.15);
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .header h1 {
      font-size: clamp(2rem, 6vw, 3rem);
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 0.5rem;
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1rem;
      color: light-dark(#666, #999);
      margin: 0;
      font-weight: 400;
    }

    .filters {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .filter-categories {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.5rem 1.1rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: light-dark(#666, #aaa);
      background: transparent;
      border: 2px solid light-dark(#ddd, #444);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .filter-btn:hover {
      color: light-dark(#111, #fff);
      border-color: light-dark(#bbb, #666);
    }

    .filter-btn.active {
      color: white;
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      border-color: transparent;
      box-shadow: 0 2px 10px rgba(237, 87, 96, 0.35);
    }

    .filter-lang {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.4rem;
      background: light-dark(rgba(0, 0, 0, 0.04), rgba(255, 255, 255, 0.06));
      border-radius: 10px;
    }

    .filter-lang-buttons {
      padding: 0.3rem 0.4rem 0.3rem 0rem;
      display: flex;
      gap: 0.4rem;
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    .lang-icon {
      color: light-dark(#888, #777);
      flex-shrink: 0;
    }

    .lang-btn {
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: light-dark(#888, #777);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover {
      color: light-dark(#111, #fff);
    }

    /* Default: EN is active */
    .lang-btn[data-lang="en"] {
      color: light-dark(#111, #fff);
      background: light-dark(#fff, rgba(255, 255, 255, 0.15));
      box-shadow: 0 1px 3px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.25));
    }

    /* When lang-ru class is on html, RU is active */
    html.lang-ru .lang-btn[data-lang="en"] {
      color: light-dark(#888, #777);
      background: transparent;
      box-shadow: none;
    }

    html.lang-ru .lang-btn[data-lang="ru"] {
      color: light-dark(#111, #fff);
      background: light-dark(#fff, rgba(255, 255, 255, 0.15));
      box-shadow: 0 1px 3px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.25));
    }

    /* JS-controlled active state for clicks */
    .lang-btn.active {
      color: light-dark(#111, #fff);
      background: light-dark(#fff, rgba(255, 255, 255, 0.15));
      box-shadow: 0 1px 3px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.25));
    }

    .wishlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      padding-bottom: 3rem;
    }

    .wishlist-item.hidden {
      display: none;
    }

    .wishlist-item {
      position: relative;
      display: flex;
      flex-direction: column;
      background: light-dark(var(--glass-bg-light), var(--glass-bg-dark));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid
        light-dark(var(--glass-border-light), var(--glass-border-dark));
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow:
        0 4px 24px -1px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.3)),
        0 0 0 1px
          light-dark(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.05)) inset;
    }

    .wishlist-item:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow:
        0 20px 40px -10px light-dark(rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.5)),
        0 0 0 1px light-dark(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.1))
          inset;
    }

    .wishlist-item.item-received {
      opacity: 0.6;
    }

    .wishlist-item.item-received:hover {
      transform: none;
      box-shadow:
        0 4px 24px -1px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.3)),
        0 0 0 1px
          light-dark(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.05)) inset;
    }

    .item-image {
      position: relative;
      aspect-ratio: 4/3;
      overflow: hidden;
      background: light-dark(#f0f0f0, #1a1a1a);
    }

    .skeleton {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        light-dark(#e0e0e0, #2a2a2a) 0%,
        light-dark(#f0f0f0, #3a3a3a) 50%,
        light-dark(#e0e0e0, #2a2a2a) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite ease-in-out;
      z-index: 1;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .item-image.loaded .skeleton {
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      opacity: 0;
    }

    .item-image.loaded img {
      opacity: 1;
      transition:
        opacity 0.3s ease,
        transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .wishlist-item:hover .item-image img {
      transform: scale(1.08);
    }

    .wishlist-item.item-received:hover .item-image img {
      transform: none;
    }

    .priority-badge {
      position: absolute;
      top: 0.75rem;
      left: 0.75rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: light-dark(rgba(0, 0, 0, 0.7), rgba(255, 255, 255, 0.15));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      border-radius: 8px;
      z-index: 2;
    }

    .received-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }

    .received-badge svg {
      width: 12px;
      height: 12px;
    }

    .own-reservation-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }

    .own-reservation-badge[hidden] {
      display: none;
    }

    .own-reservation-badge svg {
      width: 12px;
      height: 12px;
    }

    .priority-high {
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      box-shadow: 0 2px 8px rgba(237, 87, 96, 0.4);
    }

    .priority-medium {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
    }

    .priority-low {
      background: light-dark(rgba(0, 0, 0, 0.6), rgba(255, 255, 255, 0.15));
    }

    .item-content {
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .item-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: light-dark(#111, #fafafa);
      line-height: 1.4;
    }

    .item-url {
      display: block;
      font-size: 0.75rem;
      color: light-dark(#888, #777);
      text-decoration: none;
      margin-bottom: 0.75rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .item-url:hover {
      color: light-dark(#111, #fff);
      text-decoration: underline;
    }

    .item-description {
      font-size: 0.85rem;
      color: light-dark(#666, #999);
      margin: 0 0 1.25rem 0;
      line-height: 1.5;
    }

    .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      gap: 1rem;
    }

    .item-price {
      position: relative;
      font-size: 1.1rem;
      font-weight: 700;
      color: light-dark(#111, #fafafa);
      font-variant-numeric: tabular-nums;
      cursor: default;
    }

    .item-price[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 6px;
      padding: 0.4rem 0.65rem;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      color: white;
      background: light-dark(rgba(0, 0, 0, 0.85), rgba(50, 50, 55, 0.95));
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }

    .item-price[data-tooltip]:hover::before {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: light-dark(rgba(0, 0, 0, 0.85), rgba(50, 50, 55, 0.95));
      z-index: 10;
    }

    .reserve-btn {
      background: light-dark(rgba(0, 0, 0, 0.05), rgba(255, 255, 255, 0.1));
      color: light-dark(#333, #eee);
      border: none;
      padding: 0.6rem 1.25rem;
      font-size: 0.8rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .reserve-btn:hover {
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(237, 87, 96, 0.4);
    }

    /* Own reservation - Cancel button */
    .reserve-btn.own-reservation {
      background: light-dark(rgba(0, 0, 0, 0.08), rgba(255, 255, 255, 0.12));
      color: light-dark(#666, #aaa);
    }

    .reserve-btn.own-reservation:hover {
      background: light-dark(rgba(0, 0, 0, 0.15), rgba(255, 255, 255, 0.2));
      color: light-dark(#333, #fff);
      transform: scale(1.05);
      box-shadow: none;
    }

    /* Reserved by someone else */
    .reserve-btn.reserved-other {
      background: linear-gradient(
        135deg,
        var(--accent-start),
        var(--accent-end)
      );
      color: white;
      cursor: default;
      box-shadow: 0 4px 15px rgba(237, 87, 96, 0.3);
    }

    /* Received - green */
    .reserve-btn.received {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      cursor: default;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .reserve-btn:disabled {
      cursor: not-allowed;
    }

    .reserve-btn:disabled:hover {
      transform: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 2rem 1rem 4rem;
      }

      .container::before {
        width: 300px;
        height: 300px;
        top: -100px;
        right: -100px;
      }

      .container::after {
        width: 250px;
        height: 250px;
        left: -100px;
      }

      .header {
        margin-bottom: 2rem;
      }

      .filters {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .filter-categories {
        width: 100%;
        gap: 0.4rem;
      }

      .filter-btn {
        padding: 0.4rem 0.85rem;
        font-size: 0.75rem;
      }

      .filter-lang {
        align-self: flex-end;
      }

      .wishlist-grid {
        grid-template-columns: 1fr;
        gap: 1.25rem;
      }

      .wishlist-item:hover {
        transform: none;
      }

      .item-footer {
        flex-direction: column;
        align-items: stretch;
      }

      .reserve-btn {
        text-align: center;
      }
    }
  </style>

  <script>
    import { actions } from "astro:actions";

    const LANG_STORAGE_KEY = "wishlist-lang";
    const VISITOR_ID_KEY = "wishlist-visitor-id";
    let currentLang: "en" | "ru" = "en";
    let currentCategory = "all";

    function getVisitorId(): string {
      return localStorage.getItem(VISITOR_ID_KEY) || "";
    }

    function getSavedLanguage(): "en" | "ru" {
      try {
        const saved = localStorage.getItem(LANG_STORAGE_KEY);
        if (saved === "en" || saved === "ru") {
          return saved;
        }
      } catch {}
      return "en";
    }

    function saveLanguage(lang: "en" | "ru") {
      try {
        localStorage.setItem(LANG_STORAGE_KEY, lang);
      } catch {}
    }

    function initializeWishlist() {
      // Check if language was set by inline script
      const isRussian = document.documentElement.classList.contains("lang-ru");
      currentLang = isRussian ? "ru" : "en";

      // Apply language translations
      if (currentLang === "ru") {
        updateLanguage("ru");
      }

      // Update prices based on language
      updatePricesForLanguage(currentLang);

      // Show content after language is applied
      document.documentElement.classList.add("lang-ready");

      initializeReserveButtons();
      initializeCategoryFilters();
      initializeLanguageSwitcher();
    }

    function initializeReserveButtons() {
      const reserveButtons =
        document.querySelectorAll<HTMLButtonElement>(".reserve-btn");
      const visitorId = getVisitorId();

      reserveButtons.forEach((button) => {
        // Skip received items
        if (button.disabled) {
          return;
        }

        const reservedBy = button.dataset.reservedBy || "";
        const isReserved = reservedBy.length > 0;
        const isOwnReservation = isReserved && reservedBy === visitorId;

        // Get badge element (in the item-image section)
        const article = button.closest("article");
        const badge = article?.querySelector(
          ".own-reservation-badge",
        ) as HTMLElement;

        // Set initial button state
        if (isReserved) {
          if (isOwnReservation) {
            // Own reservation - show Cancel and badge
            button.textContent =
              (currentLang === "ru"
                ? button.dataset.ruCancel
                : button.dataset.enCancel) ?? null;
            button.classList.add("own-reservation");
            if (badge) {
              badge.hidden = false;
              // Update badge text for current language
              const span = badge.querySelector("span");
              if (span) {
                span.textContent =
                  (currentLang === "ru"
                    ? badge.dataset.ru
                    : badge.dataset.en) ?? null;
              }
            }
          } else {
            // Someone else's reservation - show Reserved (disabled)
            button.textContent =
              (currentLang === "ru"
                ? button.dataset.ruReserved
                : button.dataset.enReserved) ?? null;
            button.classList.add("reserved-other");
            button.disabled = true;
          }
        }

        button.addEventListener("click", async function () {
          const itemId = this.dataset.itemId;
          if (!itemId) return;

          const currentReservedBy = this.dataset.reservedBy || "";
          const isCurrentlyReserved = currentReservedBy.length > 0;
          const isOwn = isCurrentlyReserved && currentReservedBy === visitorId;

          // Get badge for this item
          const itemArticle = this.closest("article");
          const itemBadge = itemArticle?.querySelector(
            ".own-reservation-badge",
          ) as HTMLElement;

          if (isCurrentlyReserved && isOwn) {
            // Cancel reservation
            this.disabled = true;
            const originalText = this.textContent;
            this.textContent =
              currentLang === "ru" ? "Отменяем..." : "Canceling...";

            const { data, error } = await actions.unreserve({
              itemId: parseInt(itemId),
              visitorId,
            });

            if (data?.success) {
              this.dataset.reservedBy = "";
              this.textContent =
                (currentLang === "ru"
                  ? this.dataset.ruReserve
                  : this.dataset.enReserve) ?? null;
              this.classList.remove("own-reservation");
              if (itemBadge) itemBadge.hidden = true;
              this.disabled = false;
            } else {
              alert(error?.message || "Failed to cancel reservation");
              this.textContent = originalText ?? null;
              this.disabled = false;
            }
          } else if (!isCurrentlyReserved) {
            // Make reservation
            this.disabled = true;
            const originalText = this.textContent;
            this.textContent =
              currentLang === "ru" ? "Резервируем..." : "Reserving...";

            const { data, error } = await actions.reserve({
              itemId: parseInt(itemId),
              visitorId,
            });

            if (data?.success) {
              this.dataset.reservedBy = visitorId;
              this.textContent =
                (currentLang === "ru"
                  ? this.dataset.ruCancel
                  : this.dataset.enCancel) ?? null;
              this.classList.add("own-reservation");
              if (itemBadge) {
                itemBadge.hidden = false;
                // Update badge text for current language
                const badgeSpan = itemBadge.querySelector("span");
                if (badgeSpan) {
                  badgeSpan.textContent =
                    (currentLang === "ru"
                      ? itemBadge.dataset.ru
                      : itemBadge.dataset.en) ?? null;
                }
              }
              this.disabled = false;
            } else {
              alert(error?.message || "Failed to reserve item");
              this.textContent = originalText ?? null;
              this.disabled = false;
            }
          }
        });
      });
    }

    function initializeCategoryFilters() {
      const filterButtons =
        document.querySelectorAll<HTMLButtonElement>(".filter-btn");
      const items = document.querySelectorAll<HTMLElement>(".wishlist-item");

      filterButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const category = btn.dataset.category;
          if (!category) return;

          currentCategory = category;

          // Update active state
          filterButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Filter items (supports multiple categories separated by comma)
          items.forEach((item) => {
            const itemCategories = (item.dataset.category || "").split(",");
            if (category === "all" || itemCategories.includes(category)) {
              item.classList.remove("hidden");
            } else {
              item.classList.add("hidden");
            }
          });
        });
      });
    }

    function initializeLanguageSwitcher() {
      const langButtons =
        document.querySelectorAll<HTMLButtonElement>(".lang-btn");

      langButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const lang = btn.dataset.lang as "en" | "ru";
          if (!lang || lang === currentLang) return;

          currentLang = lang;
          saveLanguage(lang);

          // Update lang-ru class on html (CSS handles button styling)
          if (lang === "ru") {
            document.documentElement.classList.add("lang-ru");
          } else {
            document.documentElement.classList.remove("lang-ru");
          }

          // Update all translatable elements
          updateLanguage(lang);

          // Update prices for new language
          updatePricesForLanguage(lang);
        });
      });
    }

    function formatRubPrice(price: string): string {
      // Extract number from price like "₽4500"
      const match = price.match(/₽(\d+)/);
      if (!match) return price;
      const num = parseInt(match[1], 10);
      // Format with space as thousands separator, symbol after number
      const formatted = num.toLocaleString("ru-RU");
      return `${formatted}₽`;
    }

    function updatePricesForLanguage(lang: "en" | "ru") {
      const priceElements =
        document.querySelectorAll<HTMLElement>(".item-price");

      priceElements.forEach((el) => {
        const originalPrice = el.dataset.priceOriginal || "";
        const priceUsd = el.dataset.priceUsd;
        const priceRub = el.dataset.priceRub;
        const isOriginalUsd = el.dataset.originalIsUsd === "true";

        // Set displayed price based on language
        if (lang === "ru" && priceRub) {
          el.textContent = formatRubPrice(priceRub);
        } else {
          el.textContent = originalPrice;
        }

        // Tooltip logic:
        // - RU language: no tooltip
        // - EN + price in USD: no tooltip
        // - EN + price not in USD: show USD price in tooltip
        el.removeAttribute("data-tooltip");

        if (lang === "en" && !isOriginalUsd && priceUsd) {
          el.setAttribute("data-tooltip", priceUsd);
        }
      });
    }

    function updateLanguage(lang: "en" | "ru") {
      // Update elements with data-en and data-ru attributes
      const translatableElements =
        document.querySelectorAll<HTMLElement>("[data-en][data-ru]");

      translatableElements.forEach((el) => {
        const text = lang === "ru" ? el.dataset.ru : el.dataset.en;
        if (text !== undefined) {
          // For elements with children (like received badge), update the text node
          const span = el.querySelector("span");
          if (span) {
            span.textContent = text;
          } else if (
            el.childNodes.length === 1 &&
            el.childNodes[0].nodeType === Node.TEXT_NODE
          ) {
            el.textContent = text;
          } else {
            el.textContent = text;
          }
        }
      });

      // Update reserve buttons based on their state
      const reserveButtons =
        document.querySelectorAll<HTMLButtonElement>(".reserve-btn");
      const visitorId = getVisitorId();

      reserveButtons.forEach((btn) => {
        // Skip buttons in loading state
        if (
          btn.textContent === "Reserving..." ||
          btn.textContent === "Резервируем..." ||
          btn.textContent === "Canceling..." ||
          btn.textContent === "Отменяем..."
        ) {
          return;
        }

        const reservedBy = btn.dataset.reservedBy || "";
        const isReserved = reservedBy.length > 0;
        const isOwnReservation = isReserved && reservedBy === visitorId;
        const isReceived =
          btn.dataset.enReceived &&
          (btn.textContent === "Received" || btn.textContent === "Получено");

        if (isReceived) {
          btn.textContent =
            (lang === "ru" ? btn.dataset.ruReceived : btn.dataset.enReceived) ??
            null;
        } else if (isReserved && isOwnReservation) {
          btn.textContent =
            (lang === "ru" ? btn.dataset.ruCancel : btn.dataset.enCancel) ??
            null;
        } else if (isReserved && !isOwnReservation) {
          btn.textContent =
            (lang === "ru" ? btn.dataset.ruReserved : btn.dataset.enReserved) ??
            null;
        } else {
          btn.textContent =
            (lang === "ru" ? btn.dataset.ruReserve : btn.dataset.enReserve) ??
            null;
        }
      });
    }

    // Initialize when the page loads
    document.addEventListener("DOMContentLoaded", initializeWishlist);
  </script>
</PageLayout>
