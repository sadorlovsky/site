---
import AdminLayout from "@layouts/AdminLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import Button from "@components/kit/Button.astro";
import { Icon } from "astro-icon/components";
import { AdminPanel } from "@components/wishlist/admin";
import { verifySession } from "@lib/admin/auth";
import { categories } from "@lib/wishlist";
import { db, WishlistItem, Reservation, ExchangeRate } from "astro:db";
import { CDN_DOMAIN, CDN_DEV_DOMAIN } from "astro:env/server";

export const prerender = false;

// Verify authentication
const session = await verifySession(
  Astro.cookies,
  Astro.request.headers.get("host"),
);
if (!session) {
  return Astro.redirect("/wishlist/~/login");
}

// CDN domain
const cdnDomain = (import.meta.env.PROD
  ? CDN_DOMAIN
  : (CDN_DEV_DOMAIN ?? CDN_DOMAIN)) ?? "";

// Fetch all items, reservations, and exchange rates
const [items, reservations, exchangeRates] = await Promise.all([
  db.select().from(WishlistItem),
  db.select().from(Reservation),
  db.select().from(ExchangeRate),
]);

// Build exchange rates map: { USD: rate, EUR: rate, ... }
const exchangeRatesMap: Record<string, number> = {};
for (const rate of exchangeRates) {
  if (rate.toCurrency === "RUB") {
    exchangeRatesMap[rate.fromCurrency] = rate.rate;
  }
}

// Create reservation map
const reservationMap = new Map(reservations.map((r) => [r.itemId, r]));

// Sort: reserved items first, then by createdAt (newest first)
const sortedItems = [...items].sort((a, b) => {
  const aReserved = reservationMap.has(a.id);
  const bReserved = reservationMap.has(b.id);

  // Reserved items first
  if (aReserved && !bReserved) return -1;
  if (!aReserved && bReserved) return 1;

  // Then by createdAt (newest first)
  return b.createdAt.getTime() - a.createdAt.getTime();
});

// Convert Map to array for serialization
const reservationsArray = Array.from(reservationMap.entries());
---

<AdminLayout title="Wishlist Admin">
  <PageHeader
    pageTitle={{ en: "Dashboard", ru: "Панель управления" }}
    parentLink={{ href: "/wishlist", label: { en: "Wishlist", ru: "Вишлист" } }}
    forceLang="en"
  >
    <form slot="actions" method="POST" action="/api/~/auth/logout">
      <Button type="submit" variant="secondary" size="sm">
        <Icon name="log-out" width={14} height={14} />
        Logout
      </Button>
    </form>
  </PageHeader>

  <AdminPanel
    client:load
    initialItems={sortedItems}
    initialReservations={reservationsArray}
    categories={categories}
    cdnDomain={cdnDomain}
    exchangeRates={exchangeRatesMap}
  />
</AdminLayout>
