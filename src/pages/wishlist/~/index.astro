---
import AdminLayout from "@components/wishlist/admin/AdminLayout.astro";
import ItemList from "@components/wishlist/admin/ItemList.astro";
import ItemModal from "@components/wishlist/admin/ItemModal.astro";
import { verifySession } from "@lib/admin/auth";
import { categories } from "@lib/wishlist";
import { db, WishlistItem, Reservation } from "astro:db";

export const prerender = false;

// Verify authentication
const session = await verifySession(Astro.cookies);
if (!session) {
  return Astro.redirect("/wishlist/~/login");
}

// Fetch all items and reservations
const [items, reservations] = await Promise.all([
  db.select().from(WishlistItem),
  db.select().from(Reservation),
]);

// Create reservation map
const reservationMap = new Map(
  reservations.map((r) => [r.itemId, r])
);

// Sort: reserved items first, then by createdAt (newest first)
const sortedItems = [...items].sort((a, b) => {
  const aReserved = reservationMap.has(a.id);
  const bReserved = reservationMap.has(b.id);

  // Reserved items first
  if (aReserved && !bReserved) return -1;
  if (!aReserved && bReserved) return 1;

  // Then by createdAt (newest first)
  return b.createdAt.getTime() - a.createdAt.getTime();
});
---

<AdminLayout title="Wishlist Admin">
  <header class="admin-header">
    <h1>Wishlist Admin</h1>
    <form method="POST" action="/api/admin/auth/logout">
      <button type="submit" class="btn btn-secondary btn-small">Logout</button>
    </form>
  </header>

  <div class="admin-section">
    <button id="add-item-btn" class="btn btn-primary add-item-btn">
      + Add Item
    </button>

    <h2>All Items ({items.length})</h2>
    <ItemList items={sortedItems} reservations={reservationMap} categories={categories} />
  </div>

  <ItemModal />
</AdminLayout>

<script>
  import { initializeAdmin } from "@client/admin";
  initializeAdmin();
</script>
