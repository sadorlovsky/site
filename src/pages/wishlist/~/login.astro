---
import AdminLayout from "@layouts/AdminLayout.astro";
import Button from "@components/kit/Button.astro";
import { Icon } from "astro-icon/components";
import { verifySession, isLocalhost } from "@lib/admin/auth";
import { hasCredentials } from "@lib/admin/webauthn";

export const prerender = false;

const host = Astro.request.headers.get("host");
const isDevMode = isLocalhost(host);

// Already authenticated? Redirect to admin
const session = await verifySession(Astro.cookies, host);
if (session) {
  return Astro.redirect("/wishlist/~");
}

// No credentials? Redirect to setup (but they need the token)
// Skip this check in dev mode
if (!isDevMode) {
  const credentialsExist = await hasCredentials();
  if (!credentialsExist) {
    return Astro.redirect("/wishlist/~/setup");
  }
}
---

<AdminLayout title="? â€” Zach">
  <div class="login-page" data-dev-mode={isDevMode ? "true" : "false"}>
    <div class="glow"></div>

    <div class="content">
      <div class="lock-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          <circle cx="12" cy="16" r="1"/>
        </svg>
      </div>

      <p class="hint">{isDevMode ? "~" : "..."}</p>

      <button id="login-btn" class="enter-btn" aria-label="Enter">
        <Icon name="fingerprint" width={24} height={24} />
      </button>

      <div id="error-message" class="error-message" hidden></div>
    </div>
  </div>
</AdminLayout>

<script>
  import { startAuthentication } from "@simplewebauthn/browser";

  const loginBtn = document.getElementById("login-btn") as HTMLButtonElement;
  const errorEl = document.getElementById("error-message") as HTMLDivElement;
  const loginPage = document.querySelector(".login-page") as HTMLDivElement;
  const isDevMode = loginPage?.dataset.devMode === "true";

  loginBtn.addEventListener("click", async () => {
    loginBtn.disabled = true;
    loginBtn.classList.add("loading");
    errorEl.hidden = true;

    try {
      // Dev mode: simple login without passkey
      if (isDevMode) {
        const res = await fetch("/api/~/auth/dev-login", { method: "POST" });
        if (res.ok) {
          window.location.href = "/wishlist/~";
        } else {
          throw new Error("~");
        }
        return;
      }

      // Production: passkey authentication
      const optionsRes = await fetch("/api/~/auth/authentication-options", {
        method: "POST",
      });

      if (!optionsRes.ok) {
        const error = await optionsRes.json();
        throw new Error(error.error || "~");
      }

      const options = await optionsRes.json();
      const credential = await startAuthentication({ optionsJSON: options });

      const verifyRes = await fetch("/api/~/auth/authentication-verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ credential }),
      });

      if (verifyRes.ok) {
        window.location.href = "/wishlist/~";
      } else {
        throw new Error("~");
      }
    } catch (error) {
      console.error("Authentication error:", error);
      errorEl.textContent = "~";
      errorEl.hidden = false;
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
    }
  });
</script>

<style>
  .login-page {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: light-dark(var(--light-bg), var(--dark-bg));
    overflow: hidden;
  }

  .glow {
    position: absolute;
    width: 300px;
    height: 300px;
    background: radial-gradient(
      circle,
      light-dark(rgba(237, 98, 146, 0.08), rgba(237, 98, 146, 0.12)) 0%,
      transparent 70%
    );
    border-radius: 50%;
    pointer-events: none;
    animation: breathe 6s ease-in-out infinite;
  }

  @keyframes breathe {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.15);
      opacity: 0.7;
    }
  }

  .content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .lock-icon {
    width: 48px;
    height: 48px;
    color: light-dark(#999, #555);
    opacity: 0.6;
  }

  .lock-icon svg {
    width: 100%;
    height: 100%;
  }

  .hint {
    font-size: 1.5rem;
    font-weight: 300;
    letter-spacing: 0.5em;
    color: light-dark(#bbb, #444);
    margin: 0;
    user-select: none;
  }

  .enter-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
    border: none;
    border-radius: 50%;
    background: light-dark(rgba(0, 0, 0, 0.04), rgba(255, 255, 255, 0.06));
    color: light-dark(#666, #888);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .enter-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
    color: white;
    transform: scale(1.08);
    box-shadow: 0 8px 32px rgba(237, 87, 96, 0.35);
  }

  .enter-btn:active:not(:disabled) {
    transform: scale(0.98);
  }

  .enter-btn:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .enter-btn.loading {
    animation: pulse-loading 1.5s ease-in-out infinite;
  }

  @keyframes pulse-loading {
    0%, 100% {
      opacity: 0.5;
      transform: scale(1);
    }
    50% {
      opacity: 0.8;
      transform: scale(1.02);
    }
  }

  .enter-btn:focus-visible {
    outline: 2px solid var(--accent-start);
    outline-offset: 4px;
  }

  .error-message {
    font-size: 0.85rem;
    color: light-dark(#dc2626, #f87171);
    letter-spacing: 0.3em;
  }

  @media (prefers-reduced-motion: reduce) {
    .glow,
    .enter-btn.loading {
      animation: none;
    }

    .enter-btn {
      transition: none;
    }
  }
</style>
