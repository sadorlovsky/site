---
import AdminLayout from "@layouts/AdminLayout.astro";
import { hasCredentials } from "@lib/admin/webauthn";
import { timingSafeEqual } from "@lib/admin/crypto";
import { SETUP_TOKEN_COOKIE, SETUP_TOKEN_EXPIRY_MS } from "@lib/admin/config";
import { ADMIN_SETUP_SECRET } from "astro:env/server";

export const prerender = false;

// DEBUG: Log environment state
console.log("[setup] ADMIN_SETUP_SECRET defined:", !!ADMIN_SETUP_SECRET);
console.log("[setup] ADMIN_SETUP_SECRET length:", ADMIN_SETUP_SECRET?.length ?? 0);

// Check if setup is allowed
let credentialsExist = false;
try {
  credentialsExist = await hasCredentials();
  console.log("[setup] credentialsExist:", credentialsExist);
} catch (error) {
  console.error("[setup] hasCredentials error:", error);
  // Return 500 with debug info if DB fails
  return new Response(JSON.stringify({ error: "DB error", details: String(error) }), {
    status: 500,
    headers: { "Content-Type": "application/json" }
  });
}

if (credentialsExist) {
  console.log("[setup] Redirecting to login - credentials exist");
  Astro.cookies.delete(SETUP_TOKEN_COOKIE, { path: "/" });
  return Astro.redirect("/wishlist/~/login");
}

// Check for token in URL (first visit)
const urlToken = Astro.url.searchParams.get("token");
console.log("[setup] urlToken present:", !!urlToken);
console.log("[setup] urlToken length:", urlToken?.length ?? 0);

if (urlToken && ADMIN_SETUP_SECRET) {
  // Validate the token
  const tokenMatch = await timingSafeEqual(urlToken, ADMIN_SETUP_SECRET);
  console.log("[setup] Token match:", tokenMatch);

  if (tokenMatch) {
    // Store token in httpOnly cookie and redirect to clean URL
    Astro.cookies.set(SETUP_TOKEN_COOKIE, urlToken, {
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: "strict",
      path: "/",
      maxAge: SETUP_TOKEN_EXPIRY_MS / 1000,
    });
    console.log("[setup] Token valid, redirecting to clean URL");
    return Astro.redirect("/wishlist/~/setup");
  } else {
    // Invalid token in URL
    console.log("[setup] Token mismatch, returning 404");
    return new Response(null, { status: 404, statusText: "Not Found" });
  }
}

// Check for token in cookie (subsequent visits)
const cookieToken = Astro.cookies.get(SETUP_TOKEN_COOKIE)?.value;
console.log("[setup] cookieToken present:", !!cookieToken);

const isValidToken = cookieToken && ADMIN_SETUP_SECRET && await timingSafeEqual(cookieToken, ADMIN_SETUP_SECRET);
console.log("[setup] isValidToken:", isValidToken);

if (!isValidToken) {
  console.log("[setup] No valid token, returning 404");
  return new Response(null, { status: 404, statusText: "Not Found" });
}

console.log("[setup] Rendering setup page");
---

<AdminLayout title="Setup - Wishlist Admin">
  <div class="auth-container">
    <div class="setup-content">
      <h1>Setup Admin Passkey</h1>
      <p>Register a passkey to secure your admin account.</p>

      <div class="form-group" style="width: 300px; margin-bottom: 1.5rem;">
        <label for="device-name">Device Name (optional)</label>
        <input
          type="text"
          id="device-name"
          placeholder="e.g., MacBook Pro"
          maxlength="50"
        />
      </div>

      <button id="register-btn" class="btn btn-primary" type="button">
        Register Passkey
      </button>

      <div id="error-message" class="error-message" hidden></div>
      <div id="success-message" class="success-message" hidden>
        Passkey registered! Redirecting...
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { startRegistration } from "@simplewebauthn/browser";

  const registerBtn = document.getElementById(
    "register-btn",
  ) as HTMLButtonElement;
  const deviceNameInput = document.getElementById(
    "device-name",
  ) as HTMLInputElement;
  const errorEl = document.getElementById("error-message") as HTMLDivElement;
  const successEl = document.getElementById(
    "success-message",
  ) as HTMLDivElement;

  registerBtn.addEventListener("click", async () => {
    registerBtn.disabled = true;
    registerBtn.textContent = "Registering...";
    errorEl.hidden = true;

    try {
      // Get registration options from server (token is in httpOnly cookie)
      const optionsRes = await fetch("/api/~/auth/registration-options", {
        method: "POST",
        credentials: "same-origin",
      });

      if (!optionsRes.ok) {
        const error = await optionsRes.json();
        throw new Error(error.error || "Failed to get options");
      }

      const options = await optionsRes.json();

      // Start registration with browser WebAuthn API
      const credential = await startRegistration({ optionsJSON: options });

      // Verify with server (token is in httpOnly cookie)
      const verifyRes = await fetch("/api/~/auth/registration-verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({
          credential,
          deviceName: deviceNameInput.value.trim() || undefined,
        }),
      });

      if (verifyRes.ok) {
        successEl.hidden = false;
        registerBtn.hidden = true;
        setTimeout(() => {
          window.location.href = "/wishlist/~";
        }, 1500);
      } else {
        const error = await verifyRes.json();
        throw new Error(error.error || "Registration failed");
      }
    } catch (error) {
      console.error("Registration error:", error);
      errorEl.textContent =
        error instanceof Error ? error.message : "Registration failed";
      errorEl.hidden = false;
      registerBtn.disabled = false;
      registerBtn.textContent = "Register Passkey";
    }
  });
</script>
