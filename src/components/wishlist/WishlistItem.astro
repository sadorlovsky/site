---
import { Image } from "astro:assets";
import {
  getCdnImageUrl,
  type WishlistItemWithReservation,
} from "@lib/wishlist";

interface Props {
  item: WishlistItemWithReservation;
  isLCP?: boolean;
}

const { item, isLCP = false } = Astro.props;
const imageUrl = getCdnImageUrl(item.imageUrl);
---

<article
  class={`wishlist-item ${item.received ? "item-received" : ""}`}
  data-item-id={item.id}
  data-category={item.category}
  aria-label={item.title}
  data-aria-label-en={item.title}
  data-aria-label-ru={item.titleRu || item.title}
>
  <div class="item-image">
    <div class="skeleton"></div>
    <Image
      class="wishlist-img"
      src={imageUrl}
      alt={item.title}
      width={560}
      height={420}
      format="webp"
      quality={80}
      loading={isLCP ? "eager" : "lazy"}
      decoding={isLCP ? "sync" : "async"}
      fetchpriority={isLCP ? "high" : undefined}
    />
    {
      item.received && (
        <div class="received-badge" data-en="Received" data-ru="Получено">
          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M13.5 4L6 11.5L2.5 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>Received</span>
        </div>
      )
    }
    <div
      class="own-reservation-badge"
      data-en="Reserved by you"
      data-ru="Вы зарезервировали"
      hidden
    >
      <svg
        width="16"
        height="16"
        viewBox="0 0 16 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M13.5 4L6 11.5L2.5 8"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
      <span>Reserved by you</span>
    </div>
  </div>
  <div class="item-content">
    <h2
      class="item-title"
      data-en={item.title}
      data-ru={item.titleRu || item.title}
    >
      {item.title}
    </h2>
    {
      item.url && (
        <a
          href={item.url}
          target="_blank"
          rel="noopener noreferrer"
          class="item-url"
          aria-label={`Open ${item.title} on external site (opens in new tab)`}
          data-aria-label-en={`Open ${item.title} on external site (opens in new tab)`}
          data-aria-label-ru={`Открыть ${item.titleRu || item.title} на внешнем сайте (откроется в новой вкладке)`}
        >
          {item.url.replace(/^https?:\/\/(www\.)?/, "").replace(/\/$/, "")}
        </a>
      )
    }
    {
      (item.description || item.descriptionRu) && (
        <p
          class="item-description"
          data-en={item.description || ""}
          data-ru={item.descriptionRu || item.description || ""}
        >
          {item.description}
        </p>
      )
    }
    <div class="item-footer">
      <span
        class="item-price"
        data-price-original={item.price}
        data-price-usd={item.priceUsd
          ? `$${(item.priceUsd / 100).toFixed(0)}`
          : null}
        data-price-rub={item.priceRub
          ? `₽${(item.priceRub / 100).toFixed(0)}`
          : null}
        data-original-is-usd={item.price.startsWith("$") ? "true" : null}
      >
        {item.price}
      </span>

      {
        !item.received && (
          <div class="reserve-wrapper">
            <button
              class="message-btn"
              data-tooltip-en="Leave a message?"
              data-tooltip-ru="Оставить сообщение?"
              aria-label="Leave a message"
              data-aria-label-en="Leave a message"
              data-aria-label-ru="Оставить сообщение"
              hidden
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button
              class="reserve-btn reserve-btn--loading"
              data-item-id={item.id}
              data-item-title={item.title}
              data-item-title-ru={item.titleRu || item.title}
              data-reserved-by={item.reservedBy}
              data-en-reserve="Reserve"
              data-ru-reserve="Зарезервировать"
              data-en-reserved="Reserved"
              data-ru-reserved="Зарезервировано"
              data-en-cancel="Cancel"
              data-ru-cancel="Отменить"
              aria-label={
                item.isReserved
                  ? `Cancel reservation for ${item.title}`
                  : `Reserve ${item.title}`
              }
              data-aria-label-en-reserve={`Reserve ${item.title}`}
              data-aria-label-ru-reserve={`Зарезервировать ${item.titleRu || item.title}`}
              data-aria-label-en-cancel={`Cancel reservation for ${item.title}`}
              data-aria-label-ru-cancel={`Отменить резервацию ${item.titleRu || item.title}`}
              data-aria-label-en-reserved={`Reserved: ${item.title}`}
              data-aria-label-ru-reserved={`Зарезервировано: ${item.titleRu || item.title}`}
            >
              {item.isReserved ? "Reserved" : "Reserve"}
            </button>
            <div
              class="reserve-popover"
              data-message={item.reservationMessage || ""}
              hidden
            >
              <div class="popover-content">
                <div class="popover-header">
                  <span class="popover-icon">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 20 20"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M10 18.333a8.333 8.333 0 1 0 0-16.666 8.333 8.333 0 0 0 0 16.666Z"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M7.5 10l1.667 1.667L12.5 8.333"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                  <span
                    class="popover-title"
                    data-en="Reserved!"
                    data-ru="Зарезервировано!"
                  >
                    Reserved!
                  </span>
                </div>
                <label
                  class="popover-label"
                  data-en="Leave an anonymous message"
                  data-ru="Оставить анонимное сообщение?"
                >
                  Leave an anonymous message
                </label>
                <textarea
                  class="popover-textarea"
                  rows="2"
                  maxlength="200"
                  data-placeholder-en="e.g., I'll bring it to the party!"
                  data-placeholder-ru="напр., Привезу на праздник!"
                  placeholder="e.g., I'll bring it to the party!"
                />
                <div class="popover-actions">
                  <button
                    type="button"
                    class="popover-btn popover-btn-skip"
                    data-en-skip="Skip"
                    data-ru-skip="Пропустить"
                    data-en-delete="Delete"
                    data-ru-delete="Удалить"
                  >
                    Skip
                  </button>
                  <button
                    type="button"
                    class="popover-btn popover-btn-save"
                    data-en="Save"
                    data-ru="Сохранить"
                  >
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>
</article>

<script>
  function initImageLoading() {
    document
      .querySelectorAll<HTMLImageElement>(".wishlist-img")
      .forEach((img) => {
        if (img.complete) {
          img.parentElement?.classList.add("loaded");
        } else {
          img.addEventListener(
            "load",
            () => {
              img.parentElement?.classList.add("loaded");
            },
            { once: true },
          );
        }
      });
  }

  initImageLoading();
  document.addEventListener("astro:page-load", initImageLoading);
</script>
