---
import type { WishlistItemWithReservation } from "@lib/wishlist";

interface Props {
  item: WishlistItemWithReservation;
}

const { item } = Astro.props;
---

<article
  class={`wishlist-item ${item.received ? "item-received" : ""}`}
  data-item-id={item.id}
  data-category={item.category}
  aria-label={item.title}
  data-aria-label-en={item.title}
  data-aria-label-ru={item.titleRu || item.title}
>
  <div class="item-image">
    <div class="skeleton"></div>
    <img
      class="wishlist-img"
      src={item.imageUrl}
      alt={item.title}
      width="400"
      height="300"
      loading="lazy"
      decoding="async"
    />
    {
      item.received && (
        <div class="received-badge" data-en="Received" data-ru="Получено">
          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M13.5 4L6 11.5L2.5 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>Received</span>
        </div>
      )
    }
    <div
      class="own-reservation-badge"
      data-en="Reserved by you"
      data-ru="Вы зарезервировали"
      hidden
    >
      <svg
        width="16"
        height="16"
        viewBox="0 0 16 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M13.5 4L6 11.5L2.5 8"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
      <span>Reserved by you</span>
    </div>
  </div>
  <div class="item-content">
    <h2
      class="item-title"
      data-en={item.title}
      data-ru={item.titleRu || item.title}
    >
      {item.title}
    </h2>
    {
      item.url && (
        <a
          href={item.url}
          target="_blank"
          rel="noopener noreferrer"
          class="item-url"
          aria-label={`Open ${item.title} on external site (opens in new tab)`}
          data-aria-label-en={`Open ${item.title} on external site (opens in new tab)`}
          data-aria-label-ru={`Открыть ${item.titleRu || item.title} на внешнем сайте (откроется в новой вкладке)`}
        >
          {item.url.replace(/^https?:\/\/(www\.)?/, "").replace(/\/$/, "")}
        </a>
      )
    }
    {
      (item.description || item.descriptionRu) && (
        <p
          class="item-description"
          data-en={item.description || ""}
          data-ru={item.descriptionRu || item.description || ""}
        >
          {item.description}
        </p>
      )
    }
    <div class="item-footer">
      <span
        class="item-price"
        data-price-original={item.price}
        data-price-usd={item.priceUsd
          ? `$${(item.priceUsd / 100).toFixed(0)}`
          : null}
        data-price-rub={item.priceRub
          ? `₽${(item.priceRub / 100).toFixed(0)}`
          : null}
        data-original-is-usd={item.price.startsWith("$") ? "true" : null}
      >
        {item.price}
      </span>

      {
        !item.received && (
          <button
            class="reserve-btn"
            data-item-id={item.id}
            data-item-title={item.title}
            data-item-title-ru={item.titleRu || item.title}
            data-reserved-by={item.reservedBy}
            data-en-reserve="Reserve"
            data-ru-reserve="Зарезервировать"
            data-en-reserved="Reserved"
            data-ru-reserved="Зарезервировано"
            data-en-cancel="Cancel"
            data-ru-cancel="Отменить"
            aria-label={
              item.isReserved
                ? `Cancel reservation for ${item.title}`
                : `Reserve ${item.title}`
            }
            data-aria-label-en-reserve={`Reserve ${item.title}`}
            data-aria-label-ru-reserve={`Зарезервировать ${item.titleRu || item.title}`}
            data-aria-label-en-cancel={`Cancel reservation for ${item.title}`}
            data-aria-label-ru-cancel={`Отменить резервацию ${item.titleRu || item.title}`}
            data-aria-label-en-reserved={`Reserved: ${item.title}`}
            data-aria-label-ru-reserved={`Зарезервировано: ${item.titleRu || item.title}`}
          >
            {item.isReserved ? "Reserved" : "Reserve"}
          </button>
        )
      }
    </div>
  </div>
</article>

<script>
  function initImageLoading() {
    document
      .querySelectorAll<HTMLImageElement>(".wishlist-img")
      .forEach((img) => {
        if (img.complete) {
          img.parentElement?.classList.add("loaded");
        } else {
          img.addEventListener(
            "load",
            () => {
              img.parentElement?.classList.add("loaded");
            },
            { once: true },
          );
        }
      });
  }

  initImageLoading();
  document.addEventListener("astro:page-load", initImageLoading);
</script>
