---
import "@styles/kit/toggle-group.css";
import type { Category } from "@lib/wishlist";

interface Props {
  categories: Category[];
  currentCategory: string;
}

const { categories, currentCategory } = Astro.props;

const otherCategories = categories.filter((c) => c.id !== "all");

// Check if slots are provided
const hasStartSlot = Astro.slots.has("start");
const hasEndSlot = Astro.slots.has("end");
---

<div
  class="mobile-filter-bar"
  role="navigation"
  aria-label="Quick category filter"
  data-aria-label-en="Quick category filter"
  data-aria-label-ru="Быстрый фильтр по категории"
  data-has-start={hasStartSlot ? "true" : undefined}
  data-has-end={hasEndSlot ? "true" : undefined}
  hidden
>
  <div class="mobile-filter-bar-inner">
    {hasStartSlot && (
      <div class="mobile-filter-start">
        <slot name="start" />
      </div>
    )}
    <div class="mobile-filter-categories-wrapper">
      <div class="kit-toggle-group kit-toggle-group--separated kit-toggle-group--sm mobile-filter-categories">
        {otherCategories.map((cat) => (
          <a
            href={cat.href}
            class:list={["kit-toggle-item", { "is-active": cat.id === currentCategory }]}
            data-category={cat.id}
            data-en={cat.label}
            data-ru={cat.labelRu}
            aria-current={cat.id === currentCategory ? "page" : undefined}
          >
            {cat.label}
          </a>
        ))}
      </div>
    </div>
    {hasEndSlot && (
      <div class="mobile-filter-end">
        <slot name="end" />
      </div>
    )}
  </div>
</div>

<style>
  .mobile-filter-bar {
    display: none;
  }

  /* Only show on narrow screens where grid is single column */
  @media (max-width: 600px) {
    .mobile-filter-bar {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 0.75rem 1rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
      background: light-dark(rgba(255, 255, 255, 0.92), rgba(30, 30, 32, 0.92));
      border-top: 1px solid
        light-dark(rgba(0, 0, 0, 0.08), rgba(255, 255, 255, 0.08));
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }

    @supports (backdrop-filter: blur(20px)) {
      .mobile-filter-bar {
        background: light-dark(rgba(255, 255, 255, 0.8), rgba(30, 30, 32, 0.8));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }
    }

    .mobile-filter-bar[hidden] {
      display: block;
      transform: translateY(100%);
    }

    .mobile-filter-bar:not([hidden]) {
      transform: translateY(0);
    }
  }

  .mobile-filter-bar-inner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    max-width: 100%;
  }

  /* Fixed slot containers */
  .mobile-filter-start,
  .mobile-filter-end {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .mobile-filter-categories-wrapper {
    position: relative;
    flex: 1;
    min-width: 0;
  }

  /* Edge fade using mask - both edges by default */
  .mobile-filter-categories {
    mask-image: linear-gradient(
      to right,
      transparent,
      black 16px,
      black calc(100% - 24px),
      transparent
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent,
      black 16px,
      black calc(100% - 24px),
      transparent
    );
  }

  /* At start position - remove left fade */
  .mobile-filter-categories-wrapper.at-start .mobile-filter-categories {
    mask-image: linear-gradient(
      to right,
      black,
      black calc(100% - 24px),
      transparent
    );
    -webkit-mask-image: linear-gradient(
      to right,
      black,
      black calc(100% - 24px),
      transparent
    );
  }

  /* At end position - remove right fade */
  .mobile-filter-categories-wrapper.at-end .mobile-filter-categories {
    mask-image: linear-gradient(to right, transparent, black 16px, black);
    -webkit-mask-image: linear-gradient(
      to right,
      transparent,
      black 16px,
      black
    );
  }

  /* At both ends - no fade */
  .mobile-filter-categories-wrapper.at-start.at-end .mobile-filter-categories {
    mask-image: none;
    -webkit-mask-image: none;
  }

  .mobile-filter-categories {
    display: flex;
    gap: 0.4rem;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex-wrap: nowrap !important;
    padding: 0.25rem 0;
    /* Reset kit-toggle-group styles */
    background: transparent !important;
  }

  .mobile-filter-categories :global(.kit-toggle-item) {
    flex-shrink: 0;
  }

  /* Drag-to-scroll cursor for desktop (only when scrollable) */
  @media (hover: hover) and (pointer: fine) {
    .mobile-filter-categories.is-scrollable {
      cursor: grab;
    }

    .mobile-filter-categories.is-scrollable:active {
      cursor: grabbing;
    }
  }

  .mobile-filter-categories::-webkit-scrollbar {
    display: none;
  }

  .mobile-filter-categories .kit-toggle-item:active {
    transform: scale(0.95);
  }



  /* Accessibility - Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .mobile-filter-bar {
      transition: none;
    }
  }

  /* Accessibility - Reduced transparency */
  @media (prefers-reduced-transparency: reduce) {
    .mobile-filter-bar {
      background: light-dark(#ffffff, #1e1e20);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
  }

  /* Accessibility - Increased contrast */
  @media (prefers-contrast: more) {
    .mobile-filter-bar {
      border-top: 2px solid light-dark(#999, #666);
    }
  }
</style>

<script>
  import { initScrollableCategories, type ScrollableCategoriesInstance } from "@client/scrollable-categories";

  let scrollable: ScrollableCategoriesInstance | null = null;
  let scrollHandler: (() => void) | null = null;
  let mediaQueryHandler: (() => void) | null = null;
  let currentMediaQuery: MediaQueryList | null = null;

  function initMobileFilterBar() {
    // Clean up previous instance
    if (scrollable) {
      scrollable.destroy();
      scrollable = null;
    }
    if (scrollHandler) {
      window.removeEventListener("scroll", scrollHandler);
      scrollHandler = null;
    }
    if (currentMediaQuery && mediaQueryHandler) {
      currentMediaQuery.removeEventListener("change", mediaQueryHandler);
      mediaQueryHandler = null;
      currentMediaQuery = null;
    }

    const barEl = document.querySelector<HTMLElement>(".mobile-filter-bar");
    const topFiltersEl = document.querySelector<HTMLElement>(".filters");

    if (!barEl || !topFiltersEl) return;

    const wrapper = barEl.querySelector<HTMLElement>(".mobile-filter-categories-wrapper");
    const scroller = barEl.querySelector<HTMLElement>(".mobile-filter-categories");

    if (!wrapper || !scroller) return;

    // Initialize shared scrollable logic
    scrollable = initScrollableCategories({ scroller, wrapper });

    // Mobile-specific visibility logic
    currentMediaQuery = window.matchMedia("(max-width: 600px)");
    let isVisible = false;
    let hasScrolledToActive = false;

    function updateVisibility() {
      if (!currentMediaQuery?.matches || !barEl || !topFiltersEl) {
        if (barEl) barEl.hidden = true;
        isVisible = false;
        return;
      }

      const filtersRect = topFiltersEl.getBoundingClientRect();
      const shouldShow = filtersRect.bottom < 0;

      if (shouldShow !== isVisible) {
        isVisible = shouldShow;
        barEl.hidden = !shouldShow;

        // Scroll to active category when bar becomes visible
        if (shouldShow && !hasScrolledToActive) {
          scrollable?.scrollToActive();
          hasScrolledToActive = true;
        }
      }
    }

    // Throttled scroll handler
    let ticking = false;
    scrollHandler = function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateVisibility();
          ticking = false;
        });
        ticking = true;
      }
    };

    mediaQueryHandler = updateVisibility;

    window.addEventListener("scroll", scrollHandler, { passive: true });
    currentMediaQuery.addEventListener("change", mediaQueryHandler);

    // Initial check
    updateVisibility();
  }

  initMobileFilterBar();
  document.addEventListener("astro:page-load", initMobileFilterBar);
</script>
