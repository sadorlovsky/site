---
import "@styles/kit/toggle-group.css";
import type { Category } from "@lib/wishlist";

interface Props {
  categories: Category[];
  currentCategory: string;
}

const { categories, currentCategory } = Astro.props;

const allCategory = categories[0];
const otherCategories = categories.slice(1);
---

{
  (
    <div
      class="mobile-filter-bar"
      role="navigation"
      aria-label="Quick category filter"
      data-aria-label-en="Quick category filter"
      data-aria-label-ru="Быстрый фильтр по категории"
      hidden
    >
      <div class="mobile-filter-bar-inner">
        <a
          href={allCategory.href}
          class:list={["kit-toggle-item", "mobile-filter-all", { "is-active": allCategory.id === currentCategory }]}
          data-category={allCategory.id}
          data-en={allCategory.label}
          data-ru={allCategory.labelRu}
          aria-current={allCategory.id === currentCategory ? "page" : undefined}
        >
          {allCategory.label}
        </a>
        <div class="mobile-filter-categories-wrapper">
          <div class="kit-toggle-group kit-toggle-group--separated kit-toggle-group--sm mobile-filter-categories">
            {otherCategories.map((cat) => (
              <a
                href={cat.href}
                class:list={["kit-toggle-item", { "is-active": cat.id === currentCategory }]}
                data-category={cat.id}
                data-en={cat.label}
                data-ru={cat.labelRu}
                aria-current={cat.id === currentCategory ? "page" : undefined}
              >
                {cat.label}
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}

<style>
  .mobile-filter-bar {
    display: none;
  }

  /* Only show on narrow screens where grid is single column */
  @media (max-width: 600px) {
    .mobile-filter-bar {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 0.75rem 1rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
      background: light-dark(rgba(255, 255, 255, 0.92), rgba(30, 30, 32, 0.92));
      border-top: 1px solid
        light-dark(rgba(0, 0, 0, 0.08), rgba(255, 255, 255, 0.08));
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }

    @supports (backdrop-filter: blur(20px)) {
      .mobile-filter-bar {
        background: light-dark(rgba(255, 255, 255, 0.8), rgba(30, 30, 32, 0.8));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }
    }

    .mobile-filter-bar[hidden] {
      display: block;
      transform: translateY(100%);
    }

    .mobile-filter-bar:not([hidden]) {
      transform: translateY(0);
    }
  }

  .mobile-filter-bar-inner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    max-width: 100%;
  }

  /* Fixed "All" button */
  .mobile-filter-all {
    flex-shrink: 0;
    height: 32px;
    padding: 0 0.85rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: light-dark(#666, #aaa);
    background: transparent;
    box-shadow: inset 0 0 0 2px light-dark(#ddd, #444);
    transition: all 0.2s ease;
  }

  .mobile-filter-all:visited {
    color: light-dark(#666, #aaa);
  }

  .mobile-filter-all:active {
    transform: scale(0.95);
  }

  .mobile-filter-all.is-active {
    color: white;
    background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
    box-shadow: 0 2px 8px rgba(237, 87, 96, 0.35);
  }

  .mobile-filter-categories-wrapper {
    position: relative;
    flex: 1;
    min-width: 0;
  }

  /* Edge fade using mask - only fade right edge since "All" is fixed on left */
  .mobile-filter-categories {
    mask-image: linear-gradient(
      to right,
      black,
      black calc(100% - 24px),
      transparent
    );
    -webkit-mask-image: linear-gradient(
      to right,
      black,
      black calc(100% - 24px),
      transparent
    );
  }

  /* Show full content when scrolled to end */
  .mobile-filter-categories-wrapper.at-end .mobile-filter-categories {
    mask-image: none;
    -webkit-mask-image: none;
  }

  /* Show full content when scrolled to both edges (no scroll needed) */
  .mobile-filter-categories-wrapper.at-start.at-end .mobile-filter-categories {
    mask-image: none;
    -webkit-mask-image: none;
  }

  .mobile-filter-categories {
    display: flex;
    gap: 0.4rem;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex-wrap: nowrap !important;
    padding: 0.25rem 0;
    /* Reset kit-toggle-group styles */
    background: transparent !important;
  }

  .mobile-filter-categories :global(.kit-toggle-item) {
    flex-shrink: 0;
  }

  /* Drag-to-scroll cursor for desktop (only when scrollable) */
  @media (hover: hover) and (pointer: fine) {
    .mobile-filter-categories.is-scrollable {
      cursor: grab;
    }

    .mobile-filter-categories.is-scrollable:active {
      cursor: grabbing;
    }
  }

  .mobile-filter-categories::-webkit-scrollbar {
    display: none;
  }

  .mobile-filter-categories .kit-toggle-item:active {
    transform: scale(0.95);
  }



  /* Accessibility - Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .mobile-filter-bar {
      transition: none;
    }
  }

  /* Accessibility - Reduced transparency */
  @media (prefers-reduced-transparency: reduce) {
    .mobile-filter-bar {
      background: light-dark(#ffffff, #1e1e20);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
  }

  /* Accessibility - Increased contrast */
  @media (prefers-contrast: more) {
    .mobile-filter-bar {
      border-top: 2px solid light-dark(#999, #666);
    }
  }
</style>

<script>
  import { initScrollableCategories } from "@client/scrollable-categories";

  function initMobileFilterBar() {
    const barEl = document.querySelector<HTMLElement>(".mobile-filter-bar");
    const topFiltersEl = document.querySelector<HTMLElement>(".filters");

    if (!barEl || !topFiltersEl) return;

    const wrapper = barEl.querySelector<HTMLElement>(".mobile-filter-categories-wrapper");
    const scroller = barEl.querySelector<HTMLElement>(".mobile-filter-categories");

    if (!wrapper || !scroller) return;

    // Initialize shared scrollable logic
    const scrollable = initScrollableCategories({ scroller, wrapper });

    // Mobile-specific visibility logic
    const mediaQuery = window.matchMedia("(max-width: 600px)");
    let isVisible = false;
    let hasScrolledToActive = false;

    function updateVisibility() {
      if (!mediaQuery.matches) {
        barEl.hidden = true;
        isVisible = false;
        return;
      }

      const filtersRect = topFiltersEl.getBoundingClientRect();
      const shouldShow = filtersRect.bottom < 0;

      if (shouldShow !== isVisible) {
        isVisible = shouldShow;
        barEl.hidden = !shouldShow;

        // Scroll to active category when bar becomes visible
        if (shouldShow && !hasScrolledToActive) {
          scrollable.scrollToActive();
          hasScrolledToActive = true;
        }
      }
    }

    // Throttled scroll handler
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateVisibility();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener("scroll", onScroll, { passive: true });
    mediaQuery.addEventListener("change", updateVisibility);

    // Initial check
    updateVisibility();
  }

  initMobileFilterBar();
  document.addEventListener("astro:page-load", initMobileFilterBar);
</script>
