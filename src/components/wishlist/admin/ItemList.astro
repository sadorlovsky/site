---
import "@styles/kit/button.css";
import { getCdnImageUrl, type Category } from "@lib/wishlist";

interface WishlistItem {
  id: number;
  title: string;
  titleRu: string | null;
  price: string;
  imageUrl: string;
  description: string | null;
  descriptionRu: string | null;
  url: string | null;
  category: string;
  priority: string | null;
  received: boolean;
  createdAt: Date;
  weight: number;
}

interface Reservation {
  itemId: number;
  reservedBy: string;
  reservedAt: Date;
}

interface Props {
  items: WishlistItem[];
  reservations: Map<number, Reservation>;
  categories: Category[];
}

const { items, reservations, categories } = Astro.props;

function getCategoryLabel(categoryId: string): string {
  const cat = categories.find((c) => c.id === categoryId);
  return cat?.label || categoryId;
}
---

<div class="items-list">
  {
    items.length === 0 ? (
      <p class="no-items">No items yet. Add your first item!</p>
    ) : (
      items.map((item) => {
        const reservation = reservations.get(item.id);
        const itemClasses = [
          "item-card",
          reservation ? "reserved" : "",
          item.received ? "received" : "",
        ]
          .filter(Boolean)
          .join(" ");

        return (
          <article class={itemClasses} data-item-id={item.id}>
            <img
              src={getCdnImageUrl(item.imageUrl)}
              alt={item.title}
              loading="lazy"
            />
            <div class="item-info">
              <h3>{item.title}</h3>
              <div class="item-meta">
                <span class="price">{item.price}</span>
                <span class="category">
                  {getCategoryLabel(item.category.split(",")[0])}
                </span>
              </div>
              <div class="item-badges">
                {item.priority && (
                  <span class={`priority priority-${item.priority}`}>
                    {item.priority}
                  </span>
                )}
                {item.received && <span class="received-badge">Received</span>}
                {reservation && <span class="reserved-badge">Reserved</span>}
              </div>
            </div>
            <div class="item-actions">
              <button
                class="kit-btn kit-btn--secondary kit-btn--sm btn-edit"
                data-item-id={item.id}
                data-item={JSON.stringify(item)}
                title="Edit"
              >
                Edit
              </button>
              <button
                class="kit-btn kit-btn--success kit-btn--sm kit-btn--icon btn-toggle-received"
                data-item-id={item.id}
                data-received={item.received}
                title={
                  item.received ? "Unmark as received" : "Mark as received"
                }
              >
                {item.received ? "✓" : "○"}
              </button>
              <button
                class="kit-btn kit-btn--danger kit-btn--sm kit-btn--icon btn-delete"
                data-item-id={item.id}
                title="Delete"
              >
                ✕
              </button>
            </div>
          </article>
        );
      })
    )
  }
</div>

<style>
  .item-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    margin-top: auto;
  }
</style>
