---
import "@styles/kit/toggle-group.css";
import type { Category } from "@lib/wishlist";
import LangSwitcher from "@components/LangSwitcher.astro";
import Button from "@components/kit/Button.astro";

interface Props {
  categories: Category[];
  currentCategory: string;
  showLangSwitcher?: boolean;
}

const { categories, currentCategory, showLangSwitcher = true } = Astro.props;

const allCategory = categories[0];
const otherCategories = categories.slice(1);
---

<div class="filters">
  <a
    href={allCategory.href}
    class:list={["kit-toggle-item", "filter-all", { "is-active": allCategory.id === currentCategory }]}
    data-category={allCategory.id}
    data-en={allCategory.label}
    data-ru={allCategory.labelRu}
    aria-current={allCategory.id === currentCategory ? "page" : undefined}
  >
    {allCategory.label}
  </a>
  <nav
    class="kit-toggle-group kit-toggle-group--separated kit-toggle-group--sm filter-categories"
    role="navigation"
    aria-label="Filter by category"
    data-aria-label-en="Filter by category"
    data-aria-label-ru="Фильтр по категории"
  >
    {
      otherCategories.map((cat) => (
        <a
          href={cat.href}
          class:list={["kit-toggle-item", { "is-active": cat.id === currentCategory }]}
          data-category={cat.id}
          data-en={cat.label}
          data-ru={cat.labelRu}
          aria-current={cat.id === currentCategory ? "page" : undefined}
        >
          {cat.label}
        </a>
      ))
    }
  </nav>
  <Button
    variant="secondary"
    size="sm"
    icon
    class="filter-random"
    aria-label="Random item"
    data-aria-label-en="Random item"
    data-aria-label-ru="Случайный подарок"
  >
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="4" y="4" width="16" height="16" rx="2" />
      <circle cx="9" cy="9" r="1" fill="currentColor" />
      <circle cx="15" cy="9" r="1" fill="currentColor" />
      <circle cx="9" cy="15" r="1" fill="currentColor" />
      <circle cx="15" cy="15" r="1" fill="currentColor" />
      <circle cx="12" cy="12" r="1" fill="currentColor" />
    </svg>
  </Button>
  {
    showLangSwitcher && (
      <LangSwitcher storageKey="lang" size="sm" />
    )
  }
</div>

<script>
  import { initScrollableCategories, type ScrollableCategoriesInstance } from "@client/scrollable-categories";
  import { initRandomButton } from "@client/wishlist-random";

  let instance: ScrollableCategoriesInstance | null = null;
  let resizeHandler: (() => void) | null = null;

  function initFilterCategories() {
    // Clean up previous instance
    if (instance) {
      instance.destroy();
      instance = null;
    }
    if (resizeHandler) {
      window.removeEventListener("resize", resizeHandler);
      resizeHandler = null;
    }

    const scroller = document.querySelector<HTMLElement>(".filter-categories");
    if (!scroller) return;

    instance = initScrollableCategories({ scroller });

    // Scroll to active category
    instance.scrollToActive();

    // Re-check edge fades on resize
    resizeHandler = instance.updateEdgeFades;
    window.addEventListener("resize", resizeHandler, { passive: true });

    // Initialize random button
    initRandomButton(".filter-random");
  }

  initFilterCategories();
  document.addEventListener("astro:page-load", initFilterCategories);
</script>
