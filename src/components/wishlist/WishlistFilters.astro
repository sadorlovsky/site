---
import type { Category } from "@lib/wishlist";
import LangSwitcher from "@components/LangSwitcher.astro";

interface Props {
  categories: Category[];
  currentCategory: string;
}

const { categories, currentCategory } = Astro.props;
---

<div class="filters">
  <nav
    class="filter-categories"
    role="navigation"
    aria-label="Filter by category"
    data-aria-label-en="Filter by category"
    data-aria-label-ru="Фильтр по категории"
  >
    {
      categories.map((cat) => (
        <a
          href={cat.href}
          class={`filter-btn ${cat.id === currentCategory ? "active" : ""}`}
          data-category={cat.id}
          data-en={cat.label}
          data-ru={cat.labelRu}
          aria-current={cat.id === currentCategory ? "page" : undefined}
        >
          {cat.label}
        </a>
      ))
    }
  </nav>
  <LangSwitcher storageKey="wishlist-lang" variant="accent" />
</div>

<script>
  function initFilterCategories() {
    const el = document.querySelector<HTMLElement>(".filter-categories");
    if (!el) return;

    // Store reference after null check for use in closures
    const categoriesEl: HTMLElement = el;

    const activeBtn =
      categoriesEl.querySelector<HTMLElement>(".filter-btn.active");

    function updateEdgeFades() {
      const { scrollLeft, scrollWidth, clientWidth } = categoriesEl;
      const threshold = 5;

      const atStart = scrollLeft <= threshold;
      const atEnd = scrollLeft + clientWidth >= scrollWidth - threshold;

      categoriesEl.classList.toggle("at-start", atStart);
      categoriesEl.classList.toggle("at-end", atEnd);
    }

    // Scroll active category to center
    function scrollToActiveCategory() {
      if (!activeBtn) return;

      const scrollLeft =
        activeBtn.offsetLeft -
        categoriesEl.offsetWidth / 2 +
        activeBtn.offsetWidth / 2;

      categoriesEl.scrollTo({
        left: Math.max(0, scrollLeft),
        behavior: "instant",
      });

      updateEdgeFades();
    }

    categoriesEl.addEventListener("scroll", updateEdgeFades, { passive: true });

    // Initial scroll to active and check edges
    scrollToActiveCategory();
    updateEdgeFades();

    // Re-check on resize
    window.addEventListener("resize", updateEdgeFades, { passive: true });
  }

  initFilterCategories();
  document.addEventListener("astro:page-load", initFilterCategories);
</script>
