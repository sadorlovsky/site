---
import PageLayout from "@layouts/PageLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import WishlistItem from "@components/wishlist/WishlistItem.astro";
import WishlistFilters from "@components/wishlist/WishlistFilters.astro";
import MobileFilterBar from "@components/wishlist/MobileFilterBar.astro";
import type { WishlistItemWithReservation, Category } from "@lib/wishlist";
import "@styles/wishlist.css";

interface Props {
  items: WishlistItemWithReservation[];
  categories: Category[];
  currentCategory: string;
  reservationsEnabled: boolean;
}

const { items, categories, currentCategory, reservationsEnabled } = Astro.props;
---

<PageLayout title="Wishlist — Zach">
  <script is:inline>
    (() => {
      const LANG_KEY = "lang";
      let lang = localStorage.getItem(LANG_KEY);

      // Migration: check old keys if no unified lang exists
      if (!lang) {
        lang = localStorage.getItem("wishlist-lang") || localStorage.getItem("travel-lang");
        if (lang) {
          localStorage.setItem(LANG_KEY, lang);
          localStorage.removeItem("wishlist-lang");
          localStorage.removeItem("travel-lang");
        }
      }

      // Detect from browser if still no lang
      if (!lang) {
        const browserLangs = navigator.languages || [navigator.language];
        const isRussian = browserLangs.some((l) =>
          l.toLowerCase().startsWith("ru"),
        );
        lang = isRussian ? "ru" : "en";
        localStorage.setItem(LANG_KEY, lang);
      }

      if (lang === "ru") {
        document.documentElement.classList.add("lang-ru");
      }

      // Generate visitorId if not exists
      if (!localStorage.getItem("wishlist-visitor-id")) {
        const id =
          crypto.randomUUID?.() ??
          Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem("wishlist-visitor-id", id);
      }

      // Apply translations immediately to prevent FOUC
      function applyTranslations() {
        document.querySelectorAll("[data-en][data-ru]").forEach((el) => {
          const text = el.getAttribute("data-" + lang);
          if (text) el.textContent = text;
        });
        document
          .querySelectorAll("[data-title-en][data-title-ru]")
          .forEach((el) => {
            const title = el.getAttribute("data-title-" + lang);
            if (title) el.setAttribute("title", title);
          });
        document
          .querySelectorAll("[data-aria-label-en][data-aria-label-ru]")
          .forEach((el) => {
            const label = el.getAttribute("data-aria-label-" + lang);
            if (label) el.setAttribute("aria-label", label);
          });

        // Apply prices based on language
        document.querySelectorAll(".item-price").forEach((el) => {
          const originalPrice = el.getAttribute("data-price-original") || "";
          const priceRub = el.getAttribute("data-price-rub");

          if (lang === "ru" && priceRub) {
            // Format RUB price with space separator
            const match = priceRub.match(/₽(\d+)/);
            if (match) {
              const num = parseInt(match[1], 10);
              const rounded = Math.round(num / 10) * 10;
              const formatted = rounded.toLocaleString("ru-RU");
              el.textContent = formatted + " ₽";
            }
          } else {
            el.textContent = originalPrice;
          }
        });
      }

      // Apply when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          applyTranslations();
          document.documentElement.classList.add("lang-ready");
        });
      } else {
        applyTranslations();
        document.documentElement.classList.add("lang-ready");
      }
    })();
  </script>

  <main>
    <div class="wishlist-container">
      <PageHeader
        variant="fancy"
        pageTitle={{ en: "Wishlist", ru: "Вишлист" }}
        subtitle={{
          en: "Things I'd love to have",
          ru: "Вещи, которые я хотел бы получить",
        }}
      />

      <WishlistFilters
        categories={categories}
        currentCategory={currentCategory}
        showLangSwitcher={true}
      />

      <div
        class="wishlist-grid"
        id="wishlist-grid"
        aria-label="Wishlist items"
        data-aria-label-en="Wishlist items"
        data-aria-label-ru="Список желаний"
      >
        {
          items.map((item, index) => (
            <WishlistItem
              item={item}
              isLCP={index === 0}
              reservationsEnabled={reservationsEnabled}
            />
          ))
        }
      </div>
    </div>
  </main>

  <MobileFilterBar categories={categories} currentCategory={currentCategory} />

  {
    reservationsEnabled && (
      <script>
        import("@client/wishlist");
      </script>
    )
  }
</PageLayout>
