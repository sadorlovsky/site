---
import PageLayout from "@layouts/PageLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import LangInit from "@components/LangInit.astro";
import WishlistItem from "@components/wishlist/WishlistItem.astro";
import WishlistFilters from "@components/wishlist/WishlistFilters.astro";
import MobileFilterBar from "@components/wishlist/MobileFilterBar.astro";
import Button from "@components/kit/Button.astro";
import { Icon } from "astro-icon/components";
import type { WishlistItemWithReservation, Category } from "@lib/wishlist";
import "@styles/wishlist.css";

interface Props {
  items: WishlistItemWithReservation[];
  categories: Category[];
  currentCategory: string;
  reservationsEnabled: boolean;
}

const { items, categories, currentCategory, reservationsEnabled } = Astro.props;

const allCategory = categories.find((c) => c.id === "all")!;
---

<PageLayout title="Wishlist — Zach">
  <LangInit />

  <script is:inline>
    (() => {
      // Generate visitorId if not exists
      if (!localStorage.getItem("wishlist-visitor-id")) {
        const id =
          crypto.randomUUID?.() ??
          Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem("wishlist-visitor-id", id);
      }

      // Apply prices based on language
      function applyPrices() {
        const lang = localStorage.getItem("lang") || "en";
        document.querySelectorAll(".item-price").forEach((el) => {
          const originalPrice = el.getAttribute("data-price-original") || "";
          const priceRub = el.getAttribute("data-price-rub");

          if (lang === "ru" && priceRub) {
            // Format RUB price with space separator
            const match = priceRub.match(/₽(\d+)/);
            if (match) {
              const num = parseInt(match[1], 10);
              const rounded = Math.round(num / 10) * 10;
              const formatted = rounded.toLocaleString("ru-RU");
              el.textContent = formatted + " ₽";
            }
          } else {
            el.textContent = originalPrice;
          }
        });
      }

      // Apply when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyPrices);
      } else {
        applyPrices();
      }

      // Re-apply prices on language change
      window.addEventListener("lang-change", applyPrices);
    })();
  </script>

  <main id="main">
    <div class="wishlist-container lang-content">
      <PageHeader
        pageTitle={{ en: "Wishlist", ru: "Вишлист" }}
        subtitle={{
          en: "Things I'd love to have",
          ru: "Вещи, которые я хотел бы получить",
        }}
        langSwitcher="lang"
      />

      <WishlistFilters
        categories={categories}
        currentCategory={currentCategory}
        showLangSwitcher={false}
      >
        <Button
          slot="start"
          variant="ghost"
          size="sm"
          href={allCategory.href}
          class:list={["filter-all-btn", { "is-active": allCategory.id === currentCategory }]}
          data-category={allCategory.id}
          data-en={allCategory.label}
          data-ru={allCategory.labelRu}
          aria-current={allCategory.id === currentCategory ? "page" : undefined}
        >
          {allCategory.label}
        </Button>
        <Button
          slot="end"
          variant="secondary"
          size="sm"
          icon
          class="filter-random"
          aria-label="Random item"
          data-aria-label-en="Random item"
          data-aria-label-ru="Случайный подарок"
          data-tooltip="Random item"
          data-tooltip-en="Random item"
          data-tooltip-ru="Случайный подарок"
        >
          <Icon name="random" width={16} height={16} />
        </Button>
      </WishlistFilters>

      <div
        class="wishlist-grid"
        id="wishlist-grid"
        aria-label="Wishlist items"
        data-aria-label-en="Wishlist items"
        data-aria-label-ru="Список желаний"
      >
        {
          items.map((item, index) => (
            <WishlistItem
              item={item}
              isLCP={index === 0}
              reservationsEnabled={reservationsEnabled}
            />
          ))
        }
      </div>
    </div>
  </main>

  <MobileFilterBar categories={categories} currentCategory={currentCategory}>
    <Button
      slot="start"
      variant="ghost"
      size="sm"
      href={allCategory.href}
      class:list={["mobile-filter-all-btn", { "is-active": allCategory.id === currentCategory }]}
      data-category={allCategory.id}
      data-en={allCategory.label}
      data-ru={allCategory.labelRu}
      aria-current={allCategory.id === currentCategory ? "page" : undefined}
    >
      {allCategory.label}
    </Button>
    <Button
      slot="end"
      variant="secondary"
      size="sm"
      icon
      class="mobile-filter-random"
      aria-label="Random item"
      data-aria-label-en="Random item"
      data-aria-label-ru="Случайный подарок"
      data-tooltip="Random item"
      data-tooltip-en="Random item"
      data-tooltip-ru="Случайный подарок"
    >
      <Icon name="random" width={16} height={16} />
    </Button>
  </MobileFilterBar>

  {
    reservationsEnabled && (
      <script>
        import("@client/wishlist");
      </script>
    )
  }

  <script>
    import { initRandomButton } from "@client/wishlist-random";

    function init() {
      initRandomButton(".filter-random");
      initRandomButton(".mobile-filter-random");
    }

    init();
    document.addEventListener("astro:page-load", init);
  </script>
</PageLayout>
