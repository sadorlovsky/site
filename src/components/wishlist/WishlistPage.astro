---
import PageLayout from "@layouts/PageLayout.astro";
import WishlistItem from "@components/wishlist/WishlistItem.astro";
import WishlistFilters from "@components/wishlist/WishlistFilters.astro";
import type { WishlistItemWithReservation, Category } from "@lib/wishlist";
import "@styles/wishlist.css";

interface Props {
  items: WishlistItemWithReservation[];
  categories: Category[];
  currentCategory: string;
}

const { items, categories, currentCategory } = Astro.props;
---

<PageLayout title="Wishlist - Zach">
  <script is:inline>
    (() => {
      const LANG_KEY = "wishlist-lang";
      let lang = localStorage.getItem(LANG_KEY);

      // If no saved language, detect from browser
      if (!lang) {
        const browserLangs = navigator.languages || [navigator.language];
        const isRussian = browserLangs.some((l) =>
          l.toLowerCase().startsWith("ru"),
        );
        lang = isRussian ? "ru" : "en";
        localStorage.setItem(LANG_KEY, lang);
      }

      if (lang === "ru") {
        document.documentElement.classList.add("lang-ru");
      }

      // Generate visitorId if not exists
      if (!localStorage.getItem("wishlist-visitor-id")) {
        const id =
          crypto.randomUUID?.() ??
          Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem("wishlist-visitor-id", id);
      }

      // Apply translations immediately to prevent FOUC
      function applyTranslations() {
        document.querySelectorAll("[data-en][data-ru]").forEach((el) => {
          const text = el.getAttribute("data-" + lang);
          if (text) el.textContent = text;
        });
        document
          .querySelectorAll("[data-title-en][data-title-ru]")
          .forEach((el) => {
            const title = el.getAttribute("data-title-" + lang);
            if (title) el.setAttribute("title", title);
          });
        document
          .querySelectorAll("[data-aria-label-en][data-aria-label-ru]")
          .forEach((el) => {
            const label = el.getAttribute("data-aria-label-" + lang);
            if (label) el.setAttribute("aria-label", label);
          });
      }

      // Apply when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          applyTranslations();
          document.documentElement.classList.add("lang-ready");
        });
      } else {
        applyTranslations();
        document.documentElement.classList.add("lang-ready");
      }
    })();
  </script>

  <main>
    <div class="wishlist-container">
      <header class="wishlist-header">
        <h1 data-en="My Wishlist" data-ru="Мой вишлист">My Wishlist</h1>
        <p
          class="subtitle"
          data-en="Things I'd love to have"
          data-ru="Вещи, которые я хотел бы получить"
        >
          Things I'd love to have
        </p>
      </header>

      <WishlistFilters
        categories={categories}
        currentCategory={currentCategory}
      />

      <div
        class="wishlist-grid"
        id="wishlist-grid"
        aria-label="Wishlist items"
        data-aria-label-en="Wishlist items"
        data-aria-label-ru="Список желаний"
      >
        {items.map((item) => <WishlistItem item={item} />)}
      </div>
    </div>
  </main>

  <script>
    import "@client/wishlist";
  </script>
</PageLayout>
