---
import PageLayout from "@layouts/PageLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import LangInit from "@components/LangInit.astro";
import WishlistItem from "@components/wishlist/WishlistItem.astro";
import WishlistFilters from "@components/wishlist/WishlistFilters.astro";
import MobileFilterBar from "@components/wishlist/MobileFilterBar.astro";
import type { WishlistItemWithReservation, Category } from "@lib/wishlist";
import "@styles/wishlist.css";

interface Props {
  items: WishlistItemWithReservation[];
  categories: Category[];
  currentCategory: string;
  reservationsEnabled: boolean;
}

const { items, categories, currentCategory, reservationsEnabled } = Astro.props;
---

<PageLayout title="Wishlist — Zach">
  <LangInit />

  <script is:inline>
    (() => {
      // Generate visitorId if not exists
      if (!localStorage.getItem("wishlist-visitor-id")) {
        const id =
          crypto.randomUUID?.() ??
          Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem("wishlist-visitor-id", id);
      }

      // Apply prices based on language
      function applyPrices() {
        const lang = localStorage.getItem("lang") || "en";
        document.querySelectorAll(".item-price").forEach((el) => {
          const originalPrice = el.getAttribute("data-price-original") || "";
          const priceRub = el.getAttribute("data-price-rub");

          if (lang === "ru" && priceRub) {
            // Format RUB price with space separator
            const match = priceRub.match(/₽(\d+)/);
            if (match) {
              const num = parseInt(match[1], 10);
              const rounded = Math.round(num / 10) * 10;
              const formatted = rounded.toLocaleString("ru-RU");
              el.textContent = formatted + " ₽";
            }
          } else {
            el.textContent = originalPrice;
          }
        });
      }

      // Apply when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyPrices);
      } else {
        applyPrices();
      }

      // Re-apply prices on language change
      window.addEventListener("lang-change", applyPrices);
    })();
  </script>

  <main>
    <div class="wishlist-container lang-content">
      <PageHeader
        variant="minimal"
        pageTitle={{ en: "Wishlist", ru: "Вишлист" }}
        subtitle={{
          en: "Things I'd love to have",
          ru: "Вещи, которые я хотел бы получить",
        }}
        langSwitcher="lang"
      />

      <WishlistFilters
        categories={categories}
        currentCategory={currentCategory}
        showLangSwitcher={false}
      />

      <div
        class="wishlist-grid"
        id="wishlist-grid"
        aria-label="Wishlist items"
        data-aria-label-en="Wishlist items"
        data-aria-label-ru="Список желаний"
      >
        {
          items.map((item, index) => (
            <WishlistItem
              item={item}
              isLCP={index === 0}
              reservationsEnabled={reservationsEnabled}
            />
          ))
        }
      </div>
    </div>
  </main>

  <MobileFilterBar categories={categories} currentCategory={currentCategory} />

  {
    reservationsEnabled && (
      <script>
        import("@client/wishlist");
      </script>
    )
  }
</PageLayout>
