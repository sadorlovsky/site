---
import "@styles/kit/toggle-group.css";
import { Icon } from "astro-icon/components";

interface Props {
  storageKey: string;
  /** Size variant - sm (32px) or md (38px) */
  size?: "sm" | "md";
}

const { storageKey, size = "sm" } = Astro.props;
---

<div
  class:list={[
    "kit-toggle-group",
    `kit-toggle-group--${size}`,
    "lang-switcher",
  ]}
  role="group"
  aria-label="Language selection"
  data-aria-label-en="Language selection"
  data-aria-label-ru="Выбор языка"
  data-storage-key={storageKey}
>
  <Icon
    name="globe"
    class="kit-toggle-group__icon lang-switcher__icon"
    aria-hidden="true"
  />
  <button
    type="button"
    class="kit-toggle-item lang-switcher__btn"
    data-lang="en"
    aria-pressed="true"
  >
    ENG
  </button>
  <button
    type="button"
    class="kit-toggle-item lang-switcher__btn"
    data-lang="ru"
    aria-pressed="false"
  >
    РУС
  </button>
</div>

<style>
  /* LangSwitcher-specific overrides */

  /* Hide globe icon on narrow screens */
  @media (max-width: 768px) {
    .lang-switcher__icon {
      display: none;
    }
  }

  /* Active state controlled by html.lang-ru class */
  .lang-switcher__btn[data-lang="en"] {
    color: light-dark(#111, #fff);
    background: light-dark(#fff, rgba(255, 255, 255, 0.15));
    box-shadow: 0 1px 3px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.25));
  }

  html.lang-ru .lang-switcher__btn[data-lang="en"] {
    color: light-dark(#555, #aaa);
    background: transparent;
    box-shadow: none;
  }

  html.lang-ru .lang-switcher__btn[data-lang="ru"] {
    color: light-dark(#111, #fff);
    background: light-dark(#fff, rgba(255, 255, 255, 0.15));
    box-shadow: 0 1px 3px light-dark(rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.25));
  }
</style>

<script is:inline>
  (function () {
    function setLang(storageKey, lang) {
      localStorage.setItem(storageKey, lang);
      // Update html lang attribute for accessibility
      document.documentElement.lang = lang;
      if (lang === "ru") {
        document.documentElement.classList.add("lang-ru");
      } else {
        document.documentElement.classList.remove("lang-ru");
      }
    }

    function applyTranslations(lang) {
      document.querySelectorAll("[data-en][data-ru]").forEach(function (el) {
        var text = el.getAttribute("data-" + lang);
        if (text) el.textContent = text;
      });
      document
        .querySelectorAll("[data-title-en][data-title-ru]")
        .forEach(function (el) {
          var title = el.getAttribute("data-title-" + lang);
          if (title) el.setAttribute("title", title);
        });
      document
        .querySelectorAll("[data-aria-label-en][data-aria-label-ru]")
        .forEach(function (el) {
          var label = el.getAttribute("data-aria-label-" + lang);
          if (label) el.setAttribute("aria-label", label);
        });
    }

    function setupLangSwitchers() {
      document.querySelectorAll(".lang-switcher").forEach(function (switcher) {
        var storageKey = switcher.dataset.storageKey;
        if (!storageKey) return;

        var buttons = switcher.querySelectorAll(".lang-switcher__btn");
        var currentLang = localStorage.getItem(storageKey) || "en";

        buttons.forEach(function (btn) {
          btn.setAttribute(
            "aria-pressed",
            btn.dataset.lang === currentLang ? "true" : "false",
          );
        });

        buttons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var lang = btn.dataset.lang;
            if (!lang) return;

            setLang(storageKey, lang);

            buttons.forEach(function (b) {
              b.setAttribute("aria-pressed", b === btn ? "true" : "false");
            });

            applyTranslations(lang);

            window.dispatchEvent(
              new CustomEvent("lang-change", {
                detail: { lang: lang, storageKey: storageKey },
              }),
            );
          });
        });
      });
    }

    setupLangSwitchers();
  })();
</script>
