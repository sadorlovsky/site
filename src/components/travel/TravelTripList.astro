---
import "flag-icons/css/flag-icons.min.css";
import {
  trips,
  groupTripsByYear,
  getSortedYears,
  formatTripDate,
} from "@lib/travel";
import styles from "./TravelTripList.module.css";

const getCountryFlag = (code: string) => {
  const parts = code.split("-");
  if (parts.length > 1) {
    return {
      isMultiple: true,
      firstPart: parts[0],
      fullCode: code,
    };
  }
  return {
    isMultiple: false,
    code: code,
  };
};

const tripsByYear = groupTripsByYear(trips);
const years = getSortedYears(tripsByYear);
---

<div class={styles.tripList}>
  {
    years.map((year) => (
      <div class={styles.yearGroup}>
        <div class={styles.yearHeader}>{year}</div>
        <div class={styles.yearTrips}>
          {tripsByYear[year].map((trip) => (
            <div class={styles.trip}>
              <div class={styles.date}>{formatTripDate(trip)}</div>
              <div class={styles.destination}>
                {trip.destinations.map((destination, index) => {
                  const flagInfo = getCountryFlag(destination.country[0]);
                  const citiesText = destination.cities.join(", ");
                  return (
                    <>
                      {index > 0 && <span class={styles.separator}>â†’</span>}
                      <div class={styles.city}>
                        {flagInfo.isMultiple ? (
                          <div class={styles.multiple}>
                            <div
                              class={[
                                styles.flag,
                                "fi",
                                `fi-${flagInfo.firstPart}`,
                              ].join(" ")}
                            />
                            <div
                              class={[
                                styles.flag,
                                "fi",
                                `fi-${flagInfo.fullCode}`,
                              ].join(" ")}
                            />
                          </div>
                        ) : (
                          <span
                            class={[
                              styles.flag,
                              "fi",
                              `fi-${flagInfo.code}`,
                            ].join(" ")}
                          />
                        )}
                        {citiesText}
                      </div>
                    </>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      </div>
    ))
  }
</div>
